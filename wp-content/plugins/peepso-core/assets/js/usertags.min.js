!function i(o,r,p){function d(e,t){if(!r[e]){if(!o[e]){var a="function"==typeof require&&require;if(!t&&a)return a(e,!0);if(h)return h(e,!0);var s=new Error("Cannot find module '"+e+"'");throw s.code="MODULE_NOT_FOUND",s}var n=r[e]={exports:{}};o[e][0].call(n.exports,function(t){return d(o[e][1][t]||t)},n,n.exports,i,o,r,p)}return r[e].exports}for(var h="function"==typeof require&&require,t=0;t<p.length;t++)d(p[t]);return d}({1:[function(t,e,a){"use strict";t("./tagging"),t("./peepsotags")},{"./peepsotags":2,"./tagging":3}],2:[function(t,e,a){"use strict";function s(){}var r,p,d,n,i;n=jQuery||$,i=peepso,r=n,d=(p=i).observer,s.prototype.init=function(){var n=this;this.taggable_inputs=d.applyFilters("peepsotags_taggable_inputs",["#postbox-main textarea.ps-postbox-textarea"]),this.init_tags(this.taggable_inputs.join(",")),this.init_tags_comments(),r(document).on("peepso_tags_init_comments ps_activitystream_append ps_activitystream_loaded peepso_repost_added",function(){n.init_tags_comments()}),r(document).on("ps_comment_save",function(){n.init_tags_comments()}),d.addFilter("postbox_req_edit",function(e,t){return t.ps_tagging("val",function(t){e.post=t}),e},10,2),d.addFilter("comment_req",function(e,t){return r(t).ps_tagging("val",function(t){e.content=t,e.post=t}),e},10,2),d.addFilter("comment_cancel",function(t){r(t).ps_tagging("reset")},10,2),d.addFilter("modalcomments.afterchange",function(t){t&&t.$attachment&&t.$attachment.find(".ps-comment-reply textarea").ps_tagging()},10,2),d.addFilter("caption_req",function(e,t){return r(t).ps_tagging("val",function(t){e.description=t}),e},10,2),d.addFilter("comment.reply",function(t,e){if(e.id!=peepsodata.currentuserid&&e.id&&e.name){var a=_.template(peepsotagsdata.template);t.val(a({id:e.id,title:e.name})+" "),t.removeData("ps_tagging"),n.init_tags_comments(t)}},10,2),r("#peepso-wrap").on("comment.saved",function(t,e,a,s){r(a).ps_tagging("reset")}),r("#peepso-wrap").on("post_edit.shown",function(t,e,a){var s=a.find("textarea");n.init_tags(s)}),d.addAction("comment_edit",r.proxy(function(t,e){var a=r(e).find("textarea");this.init_tags(a)},this),10,2),d.addAction("postbox_update",r.proxy(function(t){this.init_tags(t.$text)},this),10,1),d.addFilter("postbox_data",function(e,t){return t.$text.ps_tagging("val",function(t){e.content=t}),e},10,2)},s.prototype.init_tags=function(t){var s,n=!1,i=!1;r(t).one("focus.get_taggable",function(){var t=d.applyFilters("tags_get_taggable_params",{});n=!0,p.postJson("tagsajax.get_taggable",t,function(t){t.success&&(s=t.data.users),"function"==typeof i&&i(s||[]),n=!1})}),r(t).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(t,e){if(s)e(s,"cache");else if(n)i=e;else{var a=d.applyFilters("tags_get_taggable_params",{});p.postJson("tagsajax.get_taggable",a,function(t){t.success&&(s=t.data.users),e(s||[])})}}})},s.prototype.init_tags_comments=function(t){r(t=t||'[data-type="stream-newcomment"] textarea[name="comment"]').each(function(t,s){var n,i=!1,o=!1;r(s).off("focus.get_taggable"),r(s).one("focus.get_taggable",function(){var t=d.applyFilters("tags_get_taggable_params",{act_id:r(s).data("act-id")});i=!0,p.postJson("tagsajax.get_taggable",t,function(t){t.success&&(n=t.data.users),"function"==typeof o&&o(n||[]),i=!1})}),r(s).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(t,e){if(n)e(n,"cache");else if(i)o=e;else{var a=d.applyFilters("tags_get_taggable_params",{act_id:r(s).data("act-id")});p.postJson("tagsajax.get_taggable",a,function(t){t.success&&(n=t.data.users),e(n||[])})}}}),d.addFilter("comment_can_submit",function(t){var e=r(t.el).data("ps_tagging");return e.dropdown_is_visible&&(t.can_submit=!1),t},20,1),r(s).ps_autosize()})},s.prototype.apply_line_breaks=function(t){var o=t;o.wrap,o.setAttribute("wrap","off");var e=o.value;o.value="";var r=o.scrollWidth;function p(t,e,a){var s;if(void 0===e)e=0,a=-1,s=64;else if(-1===a)s=2*e;else{if(a-e<=1)return Math.max(2,a);s=e+(a-e)/2}var n=t.substr(0,s),i=function(t){return o.value=t,o.scrollWidth>r}(n);if(i)a=s;else{if(s>=t.length)return null;e=s}return p(t,e,a)}for(var a,s=0,n="";s<e.length;){var i=p(e.substr(s));if(null===i){n+=e.substr(s);break}var d=i-1;for(a=d-1;0<=a;a--){var h=e.charAt(s+a);if(" "===h||"-"===h||"+"===h){d=a+1;break}}n+=e.substr(s,d)+"\n",s+=d}o.value=n,o.setAttribute("wrap","")},r(function(){var t=new s;t.init(),r(".ps-postbox-tab.interactions .ps-button-cancel").on("click",function(){r("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")}),r("#postbox-main").on("postbox.post_cancel",function(){r("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")})}),d.addFilter("peepso_postbox_addons",function(t){return t.push({init:r.noop,set_postbox:function(t){"postbox-main"===t.attr("id")&&d.addFilter("postbox_req_"+t.guid,function(e){return r("#postbox-main textarea.ps-postbox-textarea").eq(0).ps_tagging("val",function(t){e.content=t}),e},10,1)}}),t},10,1)},{}],3:[function(t,e,a){"use strict";function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var i,s,o,r;i=jQuery,s=_,o=peepso,r=function(d,s){var a=13,n=27,i=38,o=40,r=/@\[\[(\d+):user:([^\]]+)\]\]/g,p=/@\[\[(\d+):user:([^\]]+)\]\]/,t=/(^|#|\s)(#[^#\s]+)/g,e='$1<span class="ps-tag">$2</span>',h=/\n/g,g="<br>",l="@",_=".ps-tagging",u=".ps-tagging-textarea",c=".ps-tagging-wrapper",f=".ps-tagging-beautifier",v=".ps-tagging-hidden",x=".ps-tagging-dropdown",m=".ps-tagging-dropdown-item",w=".active",y=".ps-tagging-loading";function b(t,e){this.textarea=t;this.options=e||{};this.init();return this}return b.prototype.init=function(){this.dom_prepare(),this.textarea.value&&(this.parse_tags(),this.textarea_on_input()),this.$textarea.off(_).on("focus"+_,d.proxy(this.textarea_on_keydown,this)).on("click"+_,d.proxy(this.textarea_on_keydown,this)).on("keydown"+_,d.proxy(this.textarea_on_keydown,this)).on("keyup"+_,d.proxy(this.textarea_on_keyup,this)).on("input"+_,d.proxy(this.textarea_on_input,this)).on("blur"+_,d.proxy(this.textarea_on_blur,this)),this.$dropdown.off(_).on("mouseenter"+_,m,d.proxy(this.dropdown_on_mouseenter,this)).on("mousedown"+_,m,d.proxy(this.dropdown_on_mousedown,this)).on("mouseup"+_,m,d.proxy(this.dropdown_on_mouseup,this))},b.prototype.dom_prepare=function(){this.$textarea=d(this.textarea),this.$textarea.addClass(".ps-tagging-textarea".substr(1)),this.$wrapper=this.$textarea.parent(c),this.$wrapper.length||(this.$textarea.wrap('<div class="'+c.substr(1)+'"></div>'),this.$wrapper=this.$textarea.parent()),this.$beautifier=this.$wrapper.children(f),this.$beautifier.length||(this.$beautifier=d('<div class="'+f.substr(1)+'"></div>'),this.$beautifier.prependTo(this.$wrapper)),this.$hidden=this.$wrapper.children(v),this.$hidden.length||(this.$hidden=d('<input type="hidden" class="'+v.substr(1)+'">'),this.$hidden.appendTo(this.$wrapper)),this.$dropdown=this.$wrapper.children(x),this.$dropdown.length||(this.$dropdown=d('<div class="'+x.substr(1)+'"></div>'),this.$dropdown.appendTo(this.$wrapper))},b.prototype.parse_tags=function(){var t,e,a,s,n,i=this.textarea.value;if(this.options.parser&&(t=this.options.parser_groups||{},i=i.replace(this.options.parser,function(){return"@[["+(arguments[t.id]||"")+":user:"+(arguments[t.title]||"")+"]]"})),e=i.match(r),this.textarea.value=i.replace(r,"$2"),this.tags_added=[],e&&e.length)for(n=0;n<e.length;n++)a=e[n].match(p),s=i.indexOf(e[n]),i=i.replace(e[n],a[2]),this.tags_added.push({id:a[1],name:a[2],start:s,length:a[2].length})},b.prototype.reset=function(){var t=this.textarea.value="",e=this.tags_added=[],a=this;setTimeout(function(){a.$textarea.trigger("keyup"),a.$textarea.trigger("input")}),this.hidden_update(t,e),this.dropdown_hide()},b.prototype.val=function(){var t=this.$hidden.val();return"function"==typeof this.options.syntax&&(t=t.replace(/@\[\[(\d+):user:([^\]]+)\]\]/g,d.proxy(function(t,e,a){return this.options.syntax({id:e,title:a})},this))),t},b.prototype.textarea_on_keydown=function(t){var e=t.keyCode;this.dropdown_is_visible&&0<=[a,n,i,o].indexOf(e)&&(t.preventDefault(),t.stopPropagation()),this.prev_sel_start=this.textarea.selectionStart,this.prev_sel_end=this.textarea.selectionEnd},b.prototype.textarea_on_keyup=function(t){var e=t.keyCode;this.dropdown_is_visible&&(e!==i&&e!==o||(this.dropdown_change_item(e),t.preventDefault(),t.stopPropagation()),e===a&&(this.dropdown_select_item(),t.preventDefault(),t.stopPropagation()),e===n&&(this.dropdown_hide(),t.preventDefault(),t.stopPropagation()))},b.prototype.textarea_on_input=function(t){var e,a,s,n,i,o,r,p,d,h,g,l=this.textarea.value;if(this.tags_added){if(this.prev_sel_start!==this.prev_sel_end)for(h=0;h<this.tags_added.length;h++)s=(a=this.tags_added[h]).start+a.length,(this.prev_sel_start>a.start&&this.prev_sel_start<s||this.prev_sel_end>a.start&&this.prev_sel_end<s||a.start>=this.prev_sel_start&&s<=this.prev_sel_end)&&this.tags_added.splice(h--,1);for(e=this.textarea.selectionStart-this.prev_sel_start-(this.prev_sel_end-this.prev_sel_start),h=0;h<this.tags_added.length;h++)if((a=this.tags_added[h]).start>=this.prev_sel_start)a.start+=e;else if((s=a.start+a.length)<this.prev_sel_start);else if(s>this.prev_sel_start){if(0<e)this.tags_added.splice(h--,1);else if(e<0){for(o=(n=l.substring(a.start,this.prev_sel_start+e)).split(" ").length-1,(n=a.name.split(" ")).splice(o,1),n=n.join(" "),i=(i=(i=a.name.split(" ")).slice(0,o)).join(" "),r=new RegExp("^([\\s\\S]{"+a.start+"})([\\s\\S]{"+(a.length+e)+"})"),p="$1"+n,this.textarea.value=this.textarea.value.replace(r,p),this.textarea.setSelectionRange(a.start+i.length,a.start+i.length),l=this.textarea.value,d=a.length-n.length,a.name=n,a.length=n.length,g=h+1;g<this.tags_added.length;g++)this.tags_added[g].start-=d;n.length||this.tags_added.splice(h--,1),h=this.tags_added.length}}else if(e<0){for((n=a.name.split(" ")).pop(),n=n.join(" "),r=new RegExp("^([\\s\\S]{"+a.start+"})([\\s\\S]{"+(a.length+e)+"})"),p="$1"+n,this.textarea.value=this.textarea.value.replace(r,p),this.textarea.setSelectionRange(a.start+n.length,a.start+n.length),l=this.textarea.value,d=a.length-n.length,a.name=n,a.length=n.length,g=h+1;g<this.tags_added.length;g++)this.tags_added[g].start-=d;n.length||this.tags_added.splice(h--,1),h=this.tags_added.length}}this.hidden_update(l,this.tags_added||[]),this.dropdown_toggle()},b.prototype.textarea_on_blur=function(t){},b.prototype.beautifier_update=function(t,e){var a,s,n,i,o;if(e.length){for(a="^",s="",o=n=0;o<e.length;o++)a+="([\\s\\S]{"+((i=e[o]).start-n)+"})([\\s\\S]{"+i.length+"})",s+="$"+(2*o+1)+"[[["+i.name+"]]]",n=i.start+i.length;a=new RegExp(a),t=t.replace(a,s)}return t=t.replace(/\[\[\[([^\[\]]+)\]\]\]/g,'<ps_span class="ps-tag">$1</ps_span>')},b.prototype.hidden_update=s.debounce(function(t,e){var a,s,n,i,o;if(e.length){for(a="^",s="",o=n=0;o<e.length;o++)a+="([\\s\\S]{"+((i=e[o]).start-n)+"})([\\s\\S]{"+i.length+"})",s+="$"+(2*o+1)+"@[["+i.id+":user:"+i.name+"]]",n=i.start+i.length;a=new RegExp(a),t=t.replace(a,s)}this.$hidden.val(t)},50),b.prototype.dropdown_toggle=s.debounce(function(){var t=this.textarea.selectionStart,e=this.textarea.value.substr(0,t),a=e.lastIndexOf("@");a<0||0<a&&!e[a-1].match(/\s/)||++a>=t?this.dropdown_hide():(e=e.substring(a,t),this.dropdown_fetch(e,d.proxy(this.dropdown_update,this)))},200),b.prototype.dropdown_fetch=function(a,s){"function"==typeof this.options.fetcher?this.dropdown_fetching||(this.dropdown_fetching=!0,this.$dropdown.find(y).show(),this.options.fetcher(a,d.proxy(function(t,e){this.$dropdown.find(y).hide(),this.dropdown_fetching=!1,"cache"===e?s(a,t):this.dropdown_toggle()},this))):s(a,[])},b.prototype.dropdown_filter=function(e,t){var a=[];return this.tags_added&&this.tags_added.length&&(a=s.map(this.tags_added,function(t){return""+t.id})),e=e.toLowerCase(),s.filter(t,function(t){return-1===a.indexOf(""+t.id)&&-1<t.name.toLowerCase().indexOf(e)})},b.prototype.dropdown_update=function(t,e){var a,s;if((e=this.dropdown_filter(t,e)).length){for(a="",s=0;s<e.length;s++)a+='<div class="'+m.substr(1)+'" data-id="'+e[s].id+'" data-name="'+e[s].name+'">',a+='<a href="#" onclick="return false;"><div class="ps-avatar"><img src="'+e[s].avatar+'"></div><span>'+e[s].name+"</span></a>",a+="</div>";this.dropdown_show(a)}},b.prototype.dropdown_show=function(t){this.$dropdown.html(t).show(),this.dropdown_is_visible=!0},b.prototype.dropdown_show_more=function(){},b.prototype.dropdown_hide=function(){this.$dropdown.hide(),this.dropdown_is_visible=!1},b.prototype.dropdown_on_mouseenter=function(t){this.dropdown_change_item(t)},b.prototype.dropdown_on_mousedown=function(){this.dropdown_is_clicked=!0},b.prototype.dropdown_on_mouseup=function(t){this.dropdown_select_item(t),this.dropdown_is_clicked=!1,this.dropdown_hide()},b.prototype.dropdown_change_item=function(t){var e,a,s,n=w.substr(1);if("number"!=typeof t)return a=(e=this.dropdown_selected_item=d(t.target)).siblings(w),e.addClass(n),void a.removeClass(n);(e=this.$dropdown.children(w)).length?(s=e[t===i?"prev":"next"](),e.removeClass(n),s.length?(this.dropdown_selected_item=s).addClass(n):this.dropdown_selected_item=!1):(e=this.dropdown_selected_item=this.$dropdown.children()[t===i?"last":"first"]()).addClass(n)},b.prototype.dropdown_select_item=function(t){var e,a,s=t?d(t.currentTarget):this.dropdown_selected_item,n=s.data("id"),i=s.data("name"),o=this.textarea.selectionStart,r=this.textarea.value.substr(0,o).lastIndexOf("@");this.tags_added||(this.tags_added=[]),this.tags_added.push({id:n,name:i,start:r,length:i.length}),e=new RegExp("^([\\s\\S]{"+r+"})[\\s\\S]{"+(o-r)+"}"),a=this.textarea.value.replace(e,"$1"+i)+" ",this.textarea.value=a,this.textarea.setSelectionRange(r+i.length+1,r+i.length+1);var p=this;setTimeout(function(){p.$textarea.trigger("keyup"),p.$textarea.trigger("input")}),this.hidden_update(a,this.tags_added),this.dropdown_hide(),this.$textarea.focus()},b}(i,s,o),i.fn.ps_tagging=function(a,s){return"object"===n(a)&&(s=a),this.each(function(){var t=i(this),e=t.data("ps_tagging");e||(e=new r(this,s),t.data("ps_tagging",e)),"val"===a&&"function"==typeof s?s(e.val()):"reset"===a&&e.reset()})},o.observer.addFilter("peepso_postbox_beautifier",function(t,e){var a=e.data("ps_tagging"),s=e.val(),n=a.tags_added||[];return a.beautifier_update(s,n)},10,2)},{}]},{},[1]);