function PsActivity(){this.current_post=null,this.is_ajax_loading={},this.is_editing={}}PsActivity.prototype.init=function(){var t=this;this.$post_container=jQuery("#ps-activitystream"),jQuery(".comment-container").each(function(e,t){0===jQuery("div",t).length&&jQuery(this).hide()}),jQuery(".cstream-respond").each(function(e,t){0===jQuery("div",t).not(".comment-container").length&&jQuery(this).hide(),jQuery("textarea[name=comment]",t).ps_autosize()}),jQuery(document).on("click",".ps-js-content-excerpt-toggle",function(e){var t,o=jQuery(e.currentTarget);if(!o.data("single-act"))return e.preventDefault(),e.stopPropagation(),(t=o.closest(".ps-js-content-excerpt")).length&&t.hide().siblings(".ps-js-content-full").show(),!1}),jQuery(document).on("ps_activitystream_loaded peepso_repost_shown peepso_report_shown ps_activitystream_append",function(e){t.toggle_anchor_target(),t.setup_comment_textarea(),t.update_pinned_color(),t.parseXFBML()}),jQuery(document).on("ps_comment_save",function(){t.setup_comment_textarea()}),jQuery(document).trigger("ps_activitystream_loaded"),jQuery(document).on("ps_comment_addon_added ps_comment_addon_removed",function(e,t){var o,s;s=(o=(t=jQuery(t)).closest(".ps-js-addons")).closest(".ps-textarea-wrapper").find("textarea"),"ps_comment_addon_added"===e.type?(t.siblings().hide(),o.show()):"ps_comment_addon_removed"===e.type&&(t.siblings(":visible").length?o.show():o.hide()),s.trigger("input")}),peepso.observer.addAction("peepso_delete_post",function(){peepsodata.activity&&+peepsodata.activity.is_permalink&&window.location.reload()})},PsActivity.prototype.setup_comment_textarea=function(){var e=jQuery('[data-type="stream-newcomment"] textarea');e.off("keydown.peepso").on("keydown.peepso",jQuery.proxy(function(e){return this.on_comment_keydown(e)},this)),e.off("keyup.peepso").on("keyup.peepso",jQuery.proxy(function(e){e.stopPropagation(),this.update_beautifier(e.target)},this))},PsActivity.prototype.update_beautifier=_.throttle(function(r){_.defer(_.bind(function(){var e,t,o,s=jQuery(r),i=s.data("ps-beautifier");i||(s.addClass("ps-tagging-textarea"),(e=s.parent(".ps-tagging-wrapper")).length||(s.wrap("<div class=ps-tagging-wrapper />"),e=s.parent(".ps-tagging-wrapper")),(i=e.children(".ps-tagging-beautifier")).length||(i=jQuery("<div class=ps-tagging-beautifier />")).prependTo(e),s.data("ps-beautifier",i),s.focus()),(o=window._wpemojiSettings||{})&&o.supports&&(o.supports.everything=!0),t=s.val()||"",t=(t=peepso.observer.applyFilters("peepso_postbox_beautifier",t,s)).replace(/<(?!\/?ps_)/g,"&lt;").replace(/<(\/?)ps_/g,"<$1").replace(/\r?\n/g,"<br />"),i.html(t)},this))},100),PsActivity.prototype.on_comment_keydown=function(e){if(e.shiftKey||e.ctrlKey)return!0;if(13===(e.keyCode?e.keyCode:e.which)){if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent))return!0;var t=jQuery(e.target),o=""===jQuery.trim(t.val());if(peepso.observer.applyFilters("comment_can_submit",{el:t,can_submit:!o}).can_submit)return this.comment_save(t.data("act-id"),e.target),e.preventDefault(),!1}return!0},PsActivity.prototype.toggle_anchor_target=function(){var t=new RegExp(location.host),e=jQuery(".ps-stream-content .cstream-attachment a, .ps-stream-content .content a, .ps-share-status-inner a").filter(function(){var e=jQuery(this).attr("href");return"http"===e.substring(0,4)&&!t.test(e)});0==peepsodata.open_in_new_tab?e.removeAttr("target"):e.attr("target","_blank")},PsActivity.prototype.action_like=function(e,t){if(this.action_like_progress)return!1;this.action_like_progress=!0;var o={act_id:t,uid:peepsodata.currentuserid},s=this,i=jQuery(e),r=jQuery(".ps-js-act-like--"+t),a=i.hasClass("liked"),n=+r.data("count")+(a?-1:1);r.html();return i.toggleClass("liked"),n<1?r.hide():(1==n?r.html('<a href="#" onclick="return activity.show_likes('+t+');">1 '+peepsodata.like_text+"</a>"):r.html('<a href="#" onclick="return activity.show_likes('+t+');">'+n+" "+peepsodata.like_text_plural+"</a>"),r.show()),peepso.postJson("activity.like",o,function(e){s.action_like_progress=!1,e.success?(i.replaceWith(e.data.like_html),r.data("count",e.data.count),0<e.data.count?r.html(e.data.count_html).show():r.hide()):(psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time),i.toggleClass("liked"),r.html(html),1<=+r.data("count")?r.show():r.hide())}),!1},PsActivity.prototype.action_repost=function(t,e){var o,s,i,r,a,n={act_id:t,uid:peepsodata.currentuserid,user_id:peepsodata.userid};return a=peepsodata.activity&&peepsodata.activity.template_repost?jQuery(peepsodata.activity.template_repost):jQuery("#repost-dialog"),e instanceof Element&&(this._action_repost_button=e),o=a.find(".dialog-title").html(),s=jQuery("#ajax-loader-gif").html(),pswindow.show(o,s),peepso.postJson("activity.ajax_show_post",n,function(e){0!=e.success?(s=a.find(".dialog-content").html(),i=a.find(".dialog-action").html(),r=(r=e.data.html.trim()).replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),r=peepso.observer.applyFilters("peepso_activity_content",r),s=(s=s.replace("{post-content}",r)).replace("{post-id}",t+""),pswindow.set_content(s).set_actions(i).refresh(),jQuery(document).trigger("peepso_repost_shown"),jQuery("#share-post-box","#ps-window").autosize(),jQuery("#ps-window").find(".ps-js-dropdown-menu").css({left:0,right:"auto"})):pswindow.hide()}),!1},PsActivity.prototype.submit_repost=function(){var p=jQuery("#postbox-post-id","#ps-window").val(),e={content:jQuery("#share-post-box","#ps-window").val(),id:peepsodata.currentuserid,uid:peepsodata.currentuserid,repost:p,acc:jQuery("#cWindowContent input[name='repost_acc']").val(),type:"activity"};return e=peepso.observer.applyFilters("postbox_req",e),peepso.postJson("postbox.post",e,function(e){if(e.success&&(pswindow.hide(),0==+peepsodata.userid||+peepsodata.currentuserid==+peepsodata.userid)){var t,o,s=peepso.observer.applyFilters("peepso_activity_content",e.data.html),i=peepso.observer.applyFilters("peepso_activity",jQuery(s)),r=jQuery("html, body"),a=jQuery("#ps-activitystream").find(".ps-js-activity").filter('[data-id="'+p+'"]');if(a.length&&(t=a.offset().top,o=r.scrollTop(),setTimeout(function(){t=a.offset().top-t,r.scrollTop(o+t)},1)),i.prependTo("#ps-activitystream"),jQuery(document).trigger("peepso_repost_added"),activity._action_repost_button){var n=jQuery(activity._action_repost_button);n.html(peepsodata.label_done).css("color","green"),n.removeAttr("onclick"),n.off("click").on("click",function(e){e.preventDefault(),e.stopPropagation(),jQuery("html, body").animate({scrollTop:i.offset().top-20})}),activity._action_repost_button=null}}}),!1},PsActivity.prototype.action_report=function(i){var e={act_id:i,uid:peepsodata.currentuserid,user_id:peepsodata.userid},t=jQuery("#activity-report-title").html();content=jQuery("#ajax-loader-gif").html(),pswindow.show(t,content),peepso.postJson("activity.ajax_show_post",e,function(e){var t=jQuery("#activity-report-content").html(),o=e.data.html.trim();o=o.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),t=(t=t.replace("{post-content}",o)).replace("{post-id}",i+""),actions=jQuery("#activity-report-actions").html(),pswindow.set_content(t).set_actions(actions).refresh();var s=jQuery("#cWindowContent .ps-js-report-desc");s.find("textarea").off("input").on("input",_.throttle(function(e){s.find(".ps-js-counter").html(e.target.value.length)},500)).triggerHandler("input"),jQuery(document).trigger("peepso_report_shown")})},PsActivity.prototype.submit_report=function(){var e=jQuery("#cWindowContent .ps-js-report-error").hide(),t=jQuery("#cWindowContent select.ps-js-report-type"),o=jQuery("#cWindowContent .ps-js-report-desc textarea"),s=t.val(),i=jQuery.trim(o.val());if(!s){var r=jQuery("#report-error-select-reason").text();return e.text(r).show(),!1}if(t.find("option:selected").data("needReason")&&!i){r=jQuery("#report-error-empty-reason").text();return e.text(r).show(),!1}var a=jQuery("#postbox-report-popup #postbox-post-id","#ps-window").val(),n=peepso.observer.applyFilters("activity_report_params",{act_id:a,uid:peepsodata.currentuserid,reason:s,reason_desc:i}),p=peepso.observer.applyFilters("activity_report_action","activity.report");return peepso.postJson(p,n,function(e){e.success?(jQuery(window).trigger("report.submitted",e),pswindow.set_content(e.notices[0]).fade_out(pswindow.fade_time)):(pswindow.hide(),psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.action_delete=function(s,t,e){return pswindow.confirm_delete(jQuery.proxy(function(){var e=jQuery.extend({uid:peepsodata.currentuserid,postid:s},t||{});pswindow.hide(),peepso.postJson("activity.delete",e,jQuery.proxy(function(e){var t,o;if(this.toggle_comment_box(s,!1),e.success){if(o=jQuery("#ps-activitystream-recent"),!(t=jQuery(".ps-js-activity").filter('[data-post-id="'+s+'"]')).length)return void peepso.observer.doAction("peepso_delete_post",s);t.css({transition:"opacity .5s","-webkit-transition":"opacity .5s"}),setTimeout(function(){t.css("opacity",0),setTimeout(function(){t.slideUp(function(){t.remove(),o.children().length||o.hide(),peepso.observer.doAction("peepso_delete_post",s)})},700)},0)}},this))},this),e),!1},PsActivity.prototype.action_pin=function(e,t){var o={postid:e,pinstatus:t,uid:peepsodata.currentuserid};return peepso.postJson("activity.pin",o,function(e){e.success&&window.location.reload()}),!1},PsActivity.prototype.action_remove_link_preview=function(e,t){var o=jQuery(".ps-js-activity--"+t);return o.length&&(o.find(".ps-stream-body .ps-stream-attachments").empty(),o.find(".ps-stream-actions .actaction-removepreview").remove(),o.find(".ps-stream-body .ps-js-activity-content .ps-js-hide-url").show(),peepso.postJson("activity.remove_link_preview",{postid:e,uid:peepsodata.currentuserid})),!1},PsActivity.prototype.on_commentbox_change=function(e){var t=jQuery(e),o=t.val();o.length>peepsodata.postsize&&(o=o.substring(0,peepsodata.postsize),t.val(o));var s=""===jQuery.trim(o),i=peepso.observer.applyFilters("comment_show_button",{el:t,show:!s}),r=t.parents(".cstream-form-input").next(".cstream-form-submit");i.show?(r.show(),r.find(".ps-comment-actions").show(),r.find(".ps-button-action").removeAttr("disabled")):(r.hide(),r.find(".ps-comment-actions").hide(),r.find(".ps-button-action").attr("disabled","disabled"))},PsActivity.prototype.comment_save=function(i,e){if(!this.is_ajax_loading["save-comment-"+i]){var r=this,a=jQuery("#act-new-comment-"+i+" .cstream-form-text");e&&e.tagName&&(a=jQuery(e).closest("#act-new-comment-"+i).find(".cstream-form-text")),jQuery("#act-new-comment-"+i+" .ps-comment-loading").show(),jQuery("#act-new-comment-"+i+" .ps-comment-actions").hide();var n=jQuery(a),t=n.val();return req=peepso.observer.applyFilters("comment_req",{act_id:i,uid:peepsodata.currentuserid,content:t,last:jQuery(".comment-container[data-act-id="+i+"] .cstream-comment:last").data("comment-id")},a),jQuery(document).trigger("ps_comment_beforesave",[i,a]),this.is_ajax_loading["save-comment-"+i]=!0,n.attr("disabled","disabled"),peepso.postJson("activity.makecomment",req,function(e){if(r.is_ajax_loading["save-comment-"+i]=!1,n.removeAttr("disabled"),e.success){var t=jQuery("<div />").append(e.data.html);t=peepso.observer.applyFilters("peepso_activity",t);var o=peepso.observer.applyFilters("peepso_activity_content",t.html()),s=jQuery(o);jQuery(".comment-container[data-act-id="+i+"]").show(),s.appendTo(".comment-container[data-act-id="+i+"]").hide().fadeIn(2e3),jQuery("#peepso-wrap").trigger("comment.saved",[i,a,req,s]),jQuery(document).trigger("ps_comment_save"),s.find(".ps-comment-body input[name=peepso_set_human_friendly]").each(function(){var e,t,o=jQuery(this),s=o.siblings(".ps-comment-message"),i=s.closest(".ps-comment-item");!+peepsodata.is_admin&&+o.data("author")!=+peepsodata.currentuserid||(e=s.find(".ps-comment__content").get(0).innerText.trim(),(t=peepso.observer.applyFilters("human_friendly_extras",[],e,i[0])).length&&(e&&t.unshift(e),e=t.join(". ")),e=e.replace(/\r?\n/g," "),peepso.modules.post.setHumanReadable(o.val(),e))})}else psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time);jQuery(document).trigger("ps_comment_aftersave",[i,a]),activity.comment_cancel(i),activity.current_post=null,jQuery("#act-new-comment-"+i+" .ps-comment-loading").hide(),jQuery("#act-new-comment-"+i+" .ps-comment-actions").hide(),jQuery("#act-new-comment-"+i+" .ps-button-action").attr("disabled","disabled"),void 0!==e.data.has_max_comments&&r.toggle_comment_box(i,e.data.has_max_comments)}),!1}},PsActivity.prototype.comment_action_edit=function(o,e){if(!(0<jQuery("#comment-item-"+o+" .cstream-content .cstream-edit").length)){var s=this,i=jQuery(e).closest("#comment-item-"+o);if(void 0===this.is_ajax_loading["comment-edit-"+o]||!1===this.is_ajax_loading["comment-edit-"+o]){this.is_ajax_loading["comment-edit-"+o]=!0;var t={postid:o,uid:peepsodata.currentuserid};peepso.postJson("activity.editcomment",t,function(e){if(e.success){var t=jQuery(e.data.html);jQuery("[data-type='stream-comment-content']",i).first().hide().after(t),jQuery(".ps-comment-media",i).hide(),jQuery("#peepso-wrap").trigger("comment_edit.shown",[o,t]),peepso.observer.doAction("comment_edit",o,t),jQuery(".cstream-edit textarea",i).on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize().off("keydown.peepso").on("keydown.peepso",function(e){if(function(e){if(13!==(e.keyCode?e.keyCode:e.which)||e.shiftKey||e.ctrlKey)return!1;if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent))return!1;var t=jQuery(e.target),o=""===jQuery.trim(t.val());return!!peepso.observer.applyFilters("comment_can_submit",{el:t,can_submit:!o}).can_submit}(e)){e.preventDefault(),e.stopPropagation();var t=jQuery(e.target).closest(".ps-comment-item[data-comment-id]").data("comment-id");activity.option_savecomment(t,e.target)}}).off("keyup.peepso").on("keyup.peepso",function(e){e.stopPropagation(),activity.update_beautifier(e.target)}).trigger("keyup.peepso"),s.is_ajax_loading["comment-edit-"+o]=!1}})}return!1}},PsActivity.prototype.option_canceleditcomment=function(e,t){var o=jQuery(t).closest("#comment-item-"+e);return 0<o.length&&(jQuery(".cstream-edit",o).remove(),jQuery("[data-type='stream-comment-content']",o).show(),jQuery(".ps-comment-media",o).show()),!1},PsActivity.prototype.option_savecomment=function(s,e){var i=jQuery(e).closest("#comment-item-"+s);if(0<i.length){var r=jQuery(".cstream-edit textarea",i).val();jQuery(".cstream-edit textarea",i).attr("disabled","disabled"),jQuery(".ps-edit-loading",i).show(),jQuery(".cstream-edit button",i).hide();var t=jQuery(".cstream-edit textarea",i),o=peepso.observer.applyFilters("comment_req",{postid:s,uid:peepsodata.currentuserid,post:r},t);jQuery(document).trigger("ps_comment_beforesave",[s,t]),peepso.postJson("activity.savecomment",o,function(e){if(e.success){jQuery(".cstream-edit",i).remove();var t=jQuery("<div />").append(e.data.html);t=peepso.observer.applyFilters("peepso_activity",t);var o=peepso.observer.applyFilters("peepso_activity_content",t.html());jQuery("[data-comment-id="+s+"] [data-type='stream-comment-content']").html(o),jQuery("[data-type='stream-comment-content']",i).show(),jQuery("[data-comment-id="+s+"] .cstream-content > .cstream-attachments").html(e.data.attachments),jQuery(".cstream-content > .cstream-attachments",i).show(),jQuery("span.ps-stream-status-action",i).html(e.data.actions),jQuery(document).trigger("ps_comment_save"),peepso.modules.post.setHumanReadable(s,r)}else psmessage.show("",e.notices[0]),jQuery(".cstream-edit button",i).show(),jQuery(".ps-edit-loading",i).hide(),jQuery(".cstream-edit textarea",i).removeAttr("disabled")})}return!1},PsActivity.prototype.comment_action_delete=function(t){var o=this;pswindow.confirm_delete(function(){var e={postid:t,uid:peepsodata.currentuserid};return peepso.postJson("activity.delete",e,function(e){o.toggle_comment_box(t,!1),e.success&&jQuery(".ps-comment-item[data-comment-id="+t+"]").remove(),pswindow.hide()}),!1})},PsActivity.prototype.comment_action_remove_preview=function(e){var t=jQuery("#comment-item-"+e);return t.length&&(t.find(".ps-comment-media").empty(),t.find(".actaction-removepreview").remove(),t.find(".ps-comment__content .ps-js-hide-url").show(),peepso.postJson("activity.remove_link_preview",{postid:e,uid:peepsodata.currentuserid})),!1},PsActivity.prototype.comment_action_report=function(r){var e={act_id:r};return peepso.postJson("activity.ajax_show_comment",e,function(e){var t=jQuery("#activity-report-title").html(),o=jQuery("#activity-report-content").html(),s=e.data.html.trim();s=s.replace("<p>","<span>").replace("</p>","<br/></span>").replace("<br/></span>","</span>"),o=(o=o.replace("{post-content}",s)).replace("{post-id}",r+""),peepso.observer.addFilter("activitystream_notice_container",function(e,t){return"#comment-item-"+t+" .cstream-more"},10,2),actions=jQuery("#activity-report-actions").html(),pswindow.show(t,o).set_actions(actions).refresh();var i=jQuery("#cWindowContent .ps-js-report-desc");i.find("textarea").off("input").on("input",_.throttle(function(e){i.find(".ps-js-counter").html(e.target.value.length)},500)).triggerHandler("input"),jQuery("#ps-window").one("pswindow.hidden",function(){peepso.observer.removeFilter("activitystream_notice_container",function(e,t){return"#comment-item-"+t+" .cstream-more"},10)})}),!1},PsActivity.prototype.comment_action_reply=function(e,t,o,s){return peepso.comment.reply(e,t,o,s),!1},PsActivity.prototype.comment_action_like=function(e,t){if(!this.comment_action_like_progress){this.comment_action_like_progress=!0;var o={act_id:t,uid:peepsodata.currentuserid},s=this,i=jQuery(e),r=jQuery(".ps-js-act-like--"+t),a=i.hasClass("liked"),n=+r.data("count")+(a?-1:1);r.html();return i.toggleClass("liked"),n<1?r.hide():(1==n?r.html('<a href="#" onclick="return activity.show_likes('+t+');">1 '+peepsodata.like_text+"</a>"):r.html('<a href="#" onclick="return activity.show_likes('+t+');">'+n+" "+peepsodata.like_text_plural+"</a>"),r.show()),peepso.postJson("activity.like",o,function(e){s.comment_action_like_progress=!1,e.success?(i.replaceWith(e.data.like_html),r.data("count",e.data.count),0<e.data.count?r.html(e.data.count_html).show():r.hide()):(psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time),i.toggleClass("liked"),r.html(html),1<=+r.data("count")?r.show():r.hide())}),!1}},PsActivity.prototype.comment_cancel=function(e){var t=jQuery("div#act-new-comment-"+e),o=t.find(".cstream-form-text");return t.find(".cstream-form-submit").hide(),t.find(".ps-js-commentbox-addons").hide(),o.val("").trigger("autosize.resize"),peepso.observer.applyFilters("comment_cancel",o),!1},PsActivity.prototype.show_likes=function(t){var e={act_id:t,uid:peepsodata.currentuserid},o=this,s="likes-"+t;return this.is_ajax_loading[s]&&(this.is_ajax_loading[s].ret&&this.is_ajax_loading[s].ret.abort(),this.is_ajax_loading[s]=!1),this.is_ajax_loading[s]=peepso.postJson("activity.get_like_names",e,function(e){jQuery("#act-like-"+t+" a").replaceWith(e.data.html),o.is_ajax_loading[s]=!1}),!1},PsActivity.prototype.show_comments=function(e,t){return peepso.comment.show_previous(e,t),!1},PsActivity.prototype.option_edit=function(r,t){var a="edit-post-"+t;if(!this.is_editing[a]){this.is_editing[a]=!0;var n=jQuery(".ps-js-activity--"+t),p=n.find(".ps-js-activity-content"),c=n.find(".ps-js-activity-edit"),d=n.find(".ps-stream-actions"),u=n.find(".ps-stream-body .cstream-attachments"),m=n.find(".ps-js-activity-extras");return c.ps_postbox({fetch:function(t,o){peepso.postJson("activity.editpost",{uid:peepsodata.currentuserid,postid:r},function(e){e.success&&(t.update(e.data),t.$text.off("keyup.peepso").on("keyup.peepso",function(e){e.stopPropagation(),activity.update_beautifier(e.target)}).trigger("keyup.peepso")),o()})},cancel:jQuery.proxy(function(e){this.is_editing[a]=!1,c.ps_postbox("destroy"),p.show()},this),submit:jQuery.proxy(function(e,s,i){(s=jQuery.extend({},s,{uid:peepsodata.currentuserid,act_id:t})).post=s.content,delete s.content,peepso.postJson("activity.savepost",s,jQuery.proxy(function(e){if(e.success){this.is_editing[a]=!1,c.ps_postbox("destroy");var t=jQuery("<div />").append(e.data.html);t=peepso.observer.applyFilters("peepso_activity",t);var o=peepso.observer.applyFilters("peepso_activity_content",t.html());p.html(o).show(),u.html(e.data.attachments),d.html(e.data.actions),m.html(e.data.extras||""),e.data&&e.data.timestamp&&n.find(".ps-stream-meta .ps-stream-time").html(e.data.timestamp),peepso.observer.doAction("peepso_activity_actions",d),peepso.modules.post.setHumanReadable(r,s.post)}else psmessage.show("",e.errors[0]);jQuery(document).trigger("peepso_post_edit_saved"),i()},this))},this)}),p.hide(),c.show(),!1}},PsActivity.prototype.option_canceledit=function(e){this.is_editing["edit-post-"+e]=!1;var t=jQuery(".ps-js-activity--"+e);return 0<t.length&&(jQuery(".cstream-edit",t).remove(),jQuery(".cstream-attachment",t).show()),!1},PsActivity.prototype.option_cancel_edit_description=function(e){var t=jQuery(".ps-js-modal-attachment--"+e);return 0<t.length&&(jQuery(".cstream-edit",t).remove(),jQuery(".cstream-attachment",t).show()),!1},PsActivity.prototype.option_savepost=function(t){var o=jQuery(".ps-js-activity--"+t);if(0<o.length){var e=jQuery(".cstream-edit textarea",o).val();jQuery(".cstream-edit textarea",o).attr("disabled","disabled"),jQuery(".ps-edit-loading",o).show(),jQuery(".cstream-edit button",o).hide();var s=peepso.observer.applyFilters("postbox_req_edit",{act_id:t,uid:peepsodata.currentuserid,post:e},jQuery(".cstream-edit textarea",o));peepso.postJson("activity.savepost",s,jQuery.proxy(function(e){jQuery(".cstream-edit",o).remove(),e.success?(this.is_editing["edit-post-"+t]=!1,jQuery(".ps-stream-body .cstream-attachment",o).html(e.data.html),jQuery(".ps-stream-body .cstream-attachments",o).html(e.data.attachments),jQuery(".ps-stream-actions",o).html(e.data.actions)):psmessage.show("",e.errors[0]),jQuery(".ps-stream-body .cstream-attachment, .ps-stream-body .cstream-attachments",o).show(),jQuery(document).trigger("peepso_post_edit_saved")},this))}return!1},PsActivity.prototype.option_save_description=function(e,t,o){var s=jQuery(".ps-js-modal-attachment--"+e);if(0<s.length){var i=jQuery(".cstream-edit textarea",s),r=i.val();jQuery(".cstream-edit textarea",s).attr("disabled","disabled"),jQuery(".ps-edit-loading",s).show(),jQuery(".cstream-edit button",s).hide();var a={act_id:e,type:t,object_id:o,uid:peepsodata.currentuserid,description:r};a=peepso.observer.applyFilters("caption_req",a,i),peepso.postJson("activity.save_description",a,function(e){var t=jQuery("<div />").append(e.data.html);t=peepso.observer.applyFilters("peepso_activity",t);var o=peepso.observer.applyFilters("peepso_activity_content",t.html());console.log(e.data.html),console.log(o),jQuery(".cstream-edit",s).remove(),jQuery(".ps-stream-attachment",s).html(o).show()})}return!1},PsActivity.prototype.option_hide=function(t){var e={act_id:t,uid:peepsodata.currentuserid};return peepso.postJson("activity.hidepost",e,function(e){e.success&&jQuery(".ps-js-activity--"+t).remove()}),!1},PsActivity.prototype.option_block=function(t,e){var o={uid:peepsodata.currentuserid,user_id:e};return peepso.postJson("activity.blockuser",o,function(e){e.success?jQuery(".ps-js-activity--"+t).remove():e.errors&&alert(e.errors[0])}),!1},PsActivity.prototype.option_enable_comments=function(t){var o=this;return peepso.postJson("activity.set_comments_status",{post_id:t,open:1},function(e){e.success?(o.reload(t),peepso.observer.doAction("comments_enable",t)):e.errors&&alert(e.errors[0])}),!1},PsActivity.prototype.option_disable_comments=function(t){var o=this;return peepso.postJson("activity.set_comments_status",{post_id:t,open:0},function(e){e.success?(o.reload(t),peepso.observer.doAction("comments_disable",t)):e.errors&&alert(e.errors[0])}),!1},PsActivity.prototype.reload=function(e){var t={uid:peepsodata.currentuserid,user_id:peepsodata.userid,post_id:e,context:"single",page:1,pinned:1};return peepso.postJson("activity.show_posts_per_page",t,function(e){var t=e&&e.data||{},o=jQuery(".ps-js-activity--"+t.act_id),s=jQuery(t.posts);(s=peepso.observer.applyFilters("peepso_activity",s)).find(".ps-js-activity-content, .ps-comment-item, .ps-stream-quote").each(function(){var e=jQuery(this),t=e.html();t=peepso.observer.applyFilters("peepso_activity_content",t),e.html(t)}),o.replaceWith(s),setTimeout(function(){jQuery(document).trigger("ps_activitystream_loaded"),jQuery("textarea[name=comment]",s).ps_autosize()},1)}),!1},PsActivity.prototype.change_post_privacy=function(e,t){var o,s,i,r,a,n="[class*=ps-icon-]";return e=jQuery(e),o=jQuery(".ps-js-privacy--"+t),s=o.find(".ps-js-dropdown-toggle"),i=s.find(n).attr("class"),r=e.find(n).attr("class"),s.find(n).attr("class",r),s.css("opacity",.5),(a=this.change_post_privacy)._xhr||(a._xhr={}),a._xhr[t]&&a._xhr[t].ret.abort(),a._xhr[t]=peepso.postJson("activity.change_post_privacy",{uid:peepsodata.currentuserid,user_id:peepsodata.userid,act_id:t,acc:e.data("option-value"),_wpnonce:peepsodata.peepso_nonce},function(e){s.css("opacity",""),e.has_errors&&(s.find(n).attr("class",i),psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time))}),!1},PsActivity.prototype.toggle_comment_box=function(e,t){var o=jQuery("#act-new-comment-"+e);if(o.length<=0){var s=jQuery("#comment-item-"+e);if(s.length<=0&&(s=jQuery(".ps-js-activity--"+e)),0<s.length){o=s.parent();var i=(s.parent().attr("id")+"").split("-").pop();o=jQuery("#act-new-comment-"+i)}}return o.length<=0||(t?o.hide():o.show()),!1},PsActivity.prototype.delete_activity=function(e,t){var o=jQuery.extend({act_id:e,uid:peepsodata.currentuserid,_wpnonce:jQuery("#_delete_nonce").val()},t||{}),s=jQuery("[data-act-delete-id="+e+"]"),i="";return 0<s.length&&(i=s.text()),pswindow.confirm_delete(function(){peepso.postJson("activity.ajax_delete_activity",o,function(e){e.success?window.location.reload():psmessage.show("",e.errors[0]).fade_out(psmessage.fade_time)})},i),!1},PsActivity.prototype.edit_activity_description=function(e,t,o){var s=jQuery(".ps-js-modal-attachment--"+e);if(!(0<s.find(".cstream-edit textarea").length)){var i={act_id:e,type:t,object_id:o,uid:peepsodata.currentuserid};return this.edit_activity_description_xhr&&this.edit_activity_description_xhr.ret&&this.edit_activity_description_xhr.ret.abort(),this.edit_activity_description_xhr=peepso.postJson("activity.edit_description",i,function(e){if(e.success){var t=jQuery(e.data.html);s.find(".ps-stream-attachment").first().hide().after(t),jQuery("#peepso-wrap").trigger("post_edit.shown",[e.data.act_id,t]),s.find(".cstream-edit textarea").on("input propertychange",function(){jQuery(this).val().length>peepsodata.postsize&&jQuery(this).val(jQuery(this).val().substring(0,peepsodata.postsize))}).autosize().focus()}}),!1}},PsActivity.prototype.remove_broken_thumbnails=function(){jQuery(".ps-media-thumbnail img").each(function(){var e=new Image,t=this;e.onerror=function(){jQuery(t).closest(".ps-media-thumbnail").remove()},e.src=t.src})},PsActivity.prototype.update_pinned_color=_.debounce(function(){var e,t,o,s,i,r=jQuery(".ps-stream__post-pin span"),a=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)$/;r.length&&(e=r.eq(0).closest(".ps-stream").find("a").eq(0).css("color"),t=r.css("color"),r.css("backgroundColor",e),e=e.match(a),t=t.match(a),e&&t&&(o=[+e[1],+e[2],+e[3]],s=[+t[1],+t[2],+t[3]],i=0,_.each(o,function(e,t){i+=(o[t]-s[t])*(o[t]-s[t])}),Math.sqrt(i)<50&&(t[1]=+t[1]+(30<+t[1]?-30:30),t[2]=+t[2]+(30<+t[2]?-30:30),t[3]=+t[3]+(30<+t[3]?-30:30),t="rgba("+t[1]+","+t[2]+","+t[3]+",1)",r.css("color",t))))},500),PsActivity.prototype.parseXFBML=_.throttle(function(){peepso.util.fbParseXFBML()},2e3),function(e){activity=new PsActivity,e(function(){activity.remove_broken_thumbnails(),activity.init()})}(jQuery);