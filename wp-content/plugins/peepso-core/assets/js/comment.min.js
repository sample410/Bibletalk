!function(e,t){t.comment=new(function(m,d,c){function e(){this.init()}function p(e){var t=m(e),n=t.siblings(".ps-comment-message"),o=n.closest(".ps-comment-item"),i=+peepsodata.is_admin,s=i||+t.data("author")===+peepsodata.currentuserid,r,a;if(s){r=n.find(".ps-comment__content").get(0).innerText.trim();a=d.observer.applyFilters("human_friendly_extras",[],r,o[0]);if(a.length){if(r){a.unshift(r)}r=a.join(". ")}r=r.replace(/\r?\n/g," ");c.post.setHumanReadable(t.val(),r)}}return d.npm.objectAssign(e.prototype,{init:function(){this.ajax={},m(m.proxy(function(){var e=(window.location.hash||"").match(/[#&]comment(?:\.|=)(\d+)\.(\d+)(?:\.(\d+)(?:\.(\d+))?)?/);e&&e[2]&&this.whenLoaded(e[1]).done(m.proxy(function(){this.reveal(e[1],e[2],e[3],e[4])},this))},this)),d.observer.addAction("post_loaded",function(e){var t=m(e),n=t.find("textarea[name=comment]");n.ps_autosize(),n.each(function(){var t=this;d.elements.droppable(t,{dropped:function(e){d.observer.doAction("commentbox_drop_files",t,e)}})}),t.find(".ps-comment-body input[name=peepso_set_human_friendly]").each(function(){p(this)}),t.on("click",".ps-comment-time .activity-post-age",function(e){m(e.currentTarget).children("a").each(function(){var e=m(this);if(e.children(".ps-js-autotime").length){var t=e.attr("href"),n=location.href.replace(location.hash,"");0===t.indexOf(n)&&(window.location=t,window.location.reload())}})})},10,1)},whenLoaded:function(o){return m.Deferred(function(e){var t,n=0;t=setInterval(function(){m(".ps-js-activity--"+o).length?(clearInterval(t),e.resolve()):60<n++&&(clearInterval(t),e.reject())},1e3)})},add:function(){},edit:function(){},reply:function(e,t,n,o){var i,s,r,a="#comment-item-"+t;r=(i=(n?m(n).closest(a):m(a)).find(".actaction-reply")).closest(".ps-comment").hasClass("ps-comment-nested")?(s=i.closest(".ps-comment").children(".ps-comment-reply")).find("textarea"):(s=i.closest(".ps-comment-item").next(".ps-comment-nested").children(".ps-comment-reply")).find("textarea"),s.not(":visible")&&s.show(),r.focus(),o=o||{},d.observer.applyFilters("comment.reply",r,m.extend({},o,{act_id:e,post_id:t})),r.off("keyup.peepso").on("keyup.peepso",function(e){e.stopPropagation(),activity.update_beautifier(e.target)}).trigger("keyup.peepso")},show_previous:function(t,e){var s,r,a,n=".ps-js-comment-container--"+t;return s=e?m(e).closest(n):m(n),r=s.find(".ps-js-comment-more").eq(0),a=r.find(".ps-js-loading"),m.Deferred(function(e){!function(o){var i=s.children(".cstream-comment:first");a.removeClass("hidden"),d.postJson("activity.show_previous_comments",{act_id:t,uid:peepsodata.currentuserid,first:i.data("comment-id")},function(e){var t=jQuery("<div />").append(e.data.html);t=d.observer.applyFilters("peepso_activity",t);var n=d.observer.applyFilters("peepso_activity_content",t.html());n=n.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"'),m(n).find(".ps-comment-body input[name=peepso_set_human_friendly]").each(function(){p(this)}),a.addClass("hidden"),0==i.length?(i=s.children(".ps-comment-more")).after(n):i.before(n),0<e.data.comments_remain?r.find("a").html(e.data.comments_remain_caption):r.remove(),m(document).trigger("ps_comment_added"),o()})}(function(){e.resolve()})})},show_all:function(t){var r=m(".ps-js-comment-container--"+t),a=r.children(".ps-js-comment-more"),c=a.find(".ps-js-loading");return m.Deferred(function(e){!function o(i){var s=r.children(".cstream-comment:first");c.removeClass("hidden"),d.postJson("activity.show_previous_comments",{act_id:t,uid:peepsodata.currentuserid,all:1,first:s.data("comment-id")},function(e){var t=jQuery("<div />").append(e.data.html);t=d.observer.applyFilters("peepso_activity",t);var n=d.observer.applyFilters("peepso_activity_content",t.html());n=n.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"'),m(n).find(".ps-comment-body input[name=peepso_set_human_friendly]").each(function(){p(this)}),c.addClass("hidden"),0==s.length?(s=r.children(".ps-comment-more")).after(n):s.before(n),0<e.data.comments_remain?(a.find("a").html(e.data.comments_remain_caption),o(i)):(a.remove(),m(document).trigger("ps_comment_added"),i())})}(function(){e.resolve()})})},reveal_comment:function(t,n){return m.Deferred(m.proxy(function(e){m("#comment-item-"+n).length?e.resolve():this.show_all(t).done(m.proxy(function(){e.resolve()},this))},this))},reveal:function(e,t,n,o){function i(e){var t=e.find("a.ps-comment-user").eq(0).css("color"),n=e.offset().top-(m(window).height()-e.outerHeight())/2;e.css({backgroundColor:t}),e.css({transition:"background-color 2s ease"}),m("html, body").delay(50).animate({scrollTop:n},500,function(){e.css({backgroundColor:""})})}this.reveal_comment(e,t).done(m.proxy(function(){o?this.reveal_comment(n,o).done(function(){i(m("#comment-item-"+o))}):i(m("#comment-item-"+t))},this))}}),e}(e,t,t.modules))}(jQuery,peepso);