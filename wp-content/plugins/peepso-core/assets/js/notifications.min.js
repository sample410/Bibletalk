!function(t){peepso=peepso||{},peepso.notification=new(function(r){var i=+peepsodata.sse;function t(){var i=this;function e(){setTimeout(function(){i.start()},3e3)}r(function(){_.defer(function(){var t=r("#peepso-wrap").length,i=r("#wpadminbar").find(".psnotification-toggle").length;if(t||i){e()}})});peepso.observer.addAction("notification_start",e);peepso.observer.addAction("notification_titlebar",function(t){i._update_titlebar(t)},10,1)}return t.prototype={_get_latest_interval:+peepsodata.get_latest_interval||3e4,_get_latest_count:function(){peepso.disableAuth().disableError().postJson("notificationsajax.get_latest_count",null,r.proxy(function(t){var a;t.success&&!t.session_timeout&&(a=0,r.each(t.data,function(t,i){var e,o,s=r("."+t),n=Math.max(0,i.count);a+=n,s.length&&(e=+(o=s.find(".ps-js-counter")).eq(0).text(),o.length&&e!==n&&(o.html(n).css("display",0<n?"":"none"),0<n&&s.data("plugin_psnotification")&&s.psnotification("clear_cache")))}),this._update_titlebar(a),peepso.observer.doAction("notification_update",t))},this))},_update_titlebar:function(t){var i,e=document.title||"",o=/^\((\d+)\)\s*/;"string"==typeof t&&t.match(/^[-+]\d+$/)&&(t=+t,t=(i=(i=e.match(o))?+i[1]:0)+t),e=e.replace(o,""),0<t&&(e="("+t+") "+e),document.title!==e&&(document.title=e)},hide:function(t){var i,e,o;void 0!==t&&((e=this.hide)[o="_progress_"+t]||(e[o]=!0,(i=r(".ps-js-notifications").find(".ps-js-notification--"+t).map(function(){return r(this).parent(".ps-notification__wrapper").get(0)})).css("opacity",.5),peepso.postJson("notificationsajax.hide",{note_id:t},r.proxy(function(t){delete e[o],t.success?(i.remove(),peepso.observer.doAction("notification_restart")):i.css("opacity","")},this))))},markAsRead:function(e){return r.Deferred(r.proxy(function(i){var t=null;e&&(t={note_id:e}),peepso.postJson("notificationsajax.mark_as_read",t,r.proxy(function(t){t.success?i.resolveWith(this):t.errors&&i.rejectWith(this,[t.errors[0]])},this))},this))},markAllAsRead:function(){return this.markAsRead()},start:function(){if(+peepsodata.currentuserid&&!this._started){if(this._started=!0,i){var t=r.proxy(function(t){"get_notifications"===t.event&&this._get_latest_count()},this);peepso.observer.addAction("peepso_sse",t,10,1)}else clearInterval(this._get_latest_timer),this._get_latest_count(),this._get_latest_timer=setInterval(r.proxy(this._get_latest_count,this),this._get_latest_interval);r(window).on("peepso_auth_required",r.proxy(function(){clearInterval(this._get_latest_timer)},this)),peepso.observer.addFilter("pschat_mark_as_read",this.restart,10,1,this),peepso.observer.addAction("notification_restart",this.restart,10,1,this)}},restart:function(){+peepsodata.currentuserid&&(i?this._get_latest_count():(clearInterval(this._get_latest_timer),this._get_latest_count(),this._get_latest_timer=setInterval(r.proxy(this._get_latest_count,this),this._get_latest_interval)))}},t}(t))}(jQuery),function(a){function e(s,t){var n=this;return this.popover=null,this.popover_list=null,this.popover_footer=null,this.popover_header=null,this._notifications={},this.init=function(t){_opts={view_all_text:peepsodata.view_all_text,view_all_link:null,source:null,request:{per_page:10,page:1},header:null,paging:!1,fetch:null},this.opts=peepso.observer.applyFilters("peepso_notification_plugin_options",_opts),this._content_is_fetched=!1,a.extend(!0,this.opts,t),a(s).addClass("psnotification-toggle"),this.popover=a("<div>"),this.popover_list=a("<div>").css({maxHeight:"40vh",overflow:"auto"}),this.popover_list.bind("mousewheel",a.proxy(function(t,i){var e=a(t.currentTarget);0<i&&0===e.scrollTop()?t.preventDefault():i<0&&e.scrollTop()==e.get(0).scrollHeight-e.innerHeight()&&t.preventDefault()},this)),a(s).append(this.popover),!1===_.isNull(this.opts.header)&&(this.popover_header=a("<div/>"),this.popover_header.addClass("ps-popover-header app-box-header").append(this.opts.header).append("<div class='ps-clearfix' />"),this.popover.append(this.popover_header)),this.popover.append(this.popover_list),this.popover_list.addClass("ps-notifications ps-notifications--empty"),this.popover.addClass("ps-popover app-box").hide(),this.opts.paging&&this.init_pagination();var e,i=this.opts.view_all_link,o=this.opts.view_all_text;i&&(o=_.isArray(o)?o:[o],i=_.isArray(i)?i:[i],e=[!1,!1,"50%","33%","25%"][i.length],i=_.map(i,function(t,i){return['<a href="',t,'"',e?' style="float:left; width:'+e+'"':"",">",o[i],"</a>"].join("")}),this.popover_footer=a('<div class="ps-popover-footer app-box-footer ps-clearfix"></div>'),this.popover_footer.append(i.join("")),this.popover_footer.appendTo(this.popover)),this.popover_list.on("mousedown.ps-notification",".ps-js-notification a",a.proxy(function(i){var e=a(i.currentTarget),o=e.closest(".ps-js-notification");+o.data("unread")&&(3===i.which||i.ctrlKey||i.altKey||(2===i.which||i.metaKey||i.shiftKey||e.on("click",function(t){t.preventDefault(),t.stopPropagation()}),o.css("opacity",.5),o.removeClass("ps-notification--unread"),peepso.notification.markAsRead(o.data("id")).done(a.proxy(function(){var t=+o.closest(".ps-js-notifications").find(".ps-js-counter").text();o.css("opacity",""),o.data("unread",0),1!==i.which||i.metaKey||i.shiftKey||(e.off("click"),e[0].click()),a(".ps-js-notifications").find(".ps-js-counter").html(t-1).css("display",1<t?"":"none")},this)).fail(function(t){o.addClass("ps-notification--unread"),t&&psmessage.show("",t)})))},this)),this.popover_list.on("mousedown click",".ps-js-mark-as-read",a.proxy(function(t){var i,e;t.preventDefault(),t.stopPropagation(),"click"===t.type&&(i=a(t.currentTarget),e=i.closest(".ps-js-notification"),i.hide(),e.css("opacity",.5),e.removeClass("ps-notification--unread"),peepso.notification.markAsRead(e.data("id")).done(a.proxy(function(){var t=+e.closest(".ps-js-notifications").find(".ps-js-counter").text();i.remove(),e.css("opacity",""),e.data("unread",0),a(".ps-js-notifications").find(".ps-js-counter").html(t-1).css("display",1<t?"":"none")},this)).fail(function(t){e.addClass("ps-notification--unread"),i.show(),t&&psmessage.show("",t)}))},this)),this.popover_footer.on("click",".ps-js-mark-all-as-read",a.proxy(function(t){var i,e=this.popover_list.find(".ps-js-notification");e=e.filter(".ps-notification--unread"),i=e.find(".ps-js-mark-as-read"),confirm(peepsodata.mark_all_as_read_confirm_text)&&(i.hide(),e.css("opacity",.5),e.removeClass("ps-notification--unread"),peepso.notification.markAllAsRead().done(function(){i.remove(),e.css("opacity",""),e.data("unread",0),a(".ps-js-notifications").find(".ps-js-counter").html(0).css("display","none")}).fail(function(t){e.addClass("ps-notification--unread"),i.show(),t&&psmessage.show("",t)}))},this)),this.popover_footer.on("click",".ps-js-toggle-unread-only",a.proxy(function(t){var i=a(t.currentTarget);this._unreadOnly=!this._unreadOnly,i.html(this._unreadOnly?peepsodata.show_all_text:peepsodata.show_unread_only_text),this.popover_list.find(".ps-notification__wrapper").remove(),this.opts.request.page=1,this._content_is_fetched=!1,this.load_page(function(){n.opts.paging&&n.popover_list.trigger("scroll")})},this))},this.fetch=function(i){var t=this.opts.request,e=(this.opts.method||"").toLowerCase();_.isFunction(this.opts.fetch)&&!1===(t=this.opts.fetch.call(this,t))||(this._notifications={},this.fetch_stop(),this.fetch_xhr=peepso["get"===e?"getJson":"postJson"](this.opts.source,t,function(t){t.success?(n._content_is_fetched=!0,n._data=t.data,n._notifications=t.data.notifications,n._errors=!1,0<n._notifications.length&&n.opts.request.page++):t.errors&&(n._content_is_fetched=!0,n._errors=t.errors),"function"==typeof i&&i()}))},this.fetch_stop=function(){this.fetch_xhr&&(this.fetch_xhr.abort?this.fetch_xhr.abort():this.fetch_xhr.ret&&this.fetch_xhr.ret.abort&&this.fetch_xhr.ret.abort())},this.refresh=function(){this.popover_list.find(".ps-notification__wrapper").remove(),this._content_is_fetched=!1,this.load_page(function(){n.opts.paging&&n.popover_list.trigger("scroll")})},this.onClick=function(t){if(!(_.isFunction(n.opts.before_click)&&!1===n.opts.before_click()||0<n.popover.has(a(t.target)).length)){t.preventDefault();var i=n.opts.lazy,e=n.popover.is(":visible");n.show(),i||e||n.load_page(function(){n.opts.paging&&n.popover_list.trigger("scroll")})}},this.render=function(){a.each(this._notifications,function(t,i){var e=a("<div class='ps-notification__wrapper'></div>");e.html(i).hide(),e.appendTo(n.popover_list).fadeIn("slow")}),a(s).trigger("notifications.shown",[a.extend(s,this)]),a(document.body).hasClass("wp-admin")&&a(s).find("a").attr("target","_blank"),this.popover_list.toggleClass("ps-notifications--empty",0===this.popover_list.find(".ps-notification__wrapper").length)},this.show=function(){this.popover.slideToggle({duration:"fast",start:function(){n.popover.position({my:"right top",at:"bottom",of:a("i",s),using:function(t,i){"right"===i.horizontal?(a(this).removeClass("flipped"),t.left+=40):(a(this).addClass("flipped"),t.left-=40),t.top+=10,a(this).css(t)}})},done:function(){a(document).on("mouseup.notification_click",function(t){a(s).is(t.target)||0!==a(s).has(t.target).length||(n.popover.hide(),a(document).off("mouseup.notification_click"))})}})},this.init_pagination=function(){this.popover_list.on("scroll",function(){n._content_is_fetched&&a(this).scrollTop()+a(this).innerHeight()>=a(this)[0].scrollHeight&&(n._content_is_fetched=!1,n.load_page(function(){n._notifications&&_.isEmpty(n._notifications)?n.popover_list.off("scroll"):n.popover_list.trigger("scroll")}))})},this.load_page=function(t){if(!1===this._content_is_fetched){var e=this.popover_list.nextAll(".ps-popover-error"),i=this.popover_list.nextAll(".ps-popover-loading");e.length&&e.remove(),i.length||(i=a("<div class='ps-popover-loading'><img src='"+peepsodata.loading_gif+"'/></div>"),this.popover_list.after(i)),this.fetch_stop(),setTimeout(function(){n.fetch(function(){i.remove(),n._errors&&(e=a("<div class=ps-popover-error />"),a.each(n._errors,function(t,i){a("<div />").html(i).appendTo(e)}),n.popover_list.after(e)),n.render(),typeof t==typeof Function&&t(),"function"==typeof n.opts.after_load&&n.opts.after_load.apply(n)})},500)}},this.clear_cache=function(){this.popover_list.find(".ps-notification__wrapper").remove(),this.popover.hide(),this.opts.request.page=1,this._content_is_fetched=!1},this.init(t),a(s).on("click",this.onClick),this}a.fn.psnotification=function(i){return this.each(function(){if(a.data(this,"plugin_psnotification")){var t=a.data(this,"plugin_psnotification");if(_.isFunction(t[i]))return t[i].call(t)}else a.data(this,"plugin_psnotification",new e(this,i))})},peepso.observer.addAction("notification_clear_cache",function(t){a("."+(t=t||"ps-js-notifications")).psnotification("clear_cache")},10,1)}(jQuery),jQuery(function(t){});