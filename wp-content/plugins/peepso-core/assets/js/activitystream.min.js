!function(){var s=function(t,h,e,n){var a=1,o=2,r=3,i="scroll.ps-activity-stream",l=+peepsodata.is_admin,s=+peepsodata.currentuserid,d=+peepsodata.userid,p=h("#peepso_post_id").val()||undefined,c=h("#peepso_context").val()||undefined;return peepso.createClass(t,{__constructor:function(t,e){this.$el=h(t);this.$recent=h("#ps-activitystream-recent");this.$loading=h("#ps-activitystream-loading");this.$noPosts=h("#ps-no-posts");this.$noPostsMatch=h("#ps-no-posts-match");this.$noMorePosts=h("#ps-no-more-posts");this.$filters=h(".ps-js-activitystream-filter");this.loading=false;this.loadEnd=false;this.loadPage=1;this.loadIds=[];this.loadLimit=+peepsodata.activity_limit_below_fold;var i=+peepsodata.loadmore_enable;if(peepso.isMobile()){i=i===a||i===o}else{i=i===a||i===r}this.loadButtonEnabled=i;this.loadButtonRepeat=this.loadButtonEnabled?+peepsodata.loadmore_repeat:0;this.loadButtonTemplate=e.template_load_more;this.isPermalink=+e.is_permalink;this.hideFromGuest=+e.hide_from_guest;this.loadLimit=this.loadLimit>0?this.loadLimit:3;h.proxy(function(t){var e,i,s,a;if(!t){return}t="core_"+t;e=h("[id=peepso_stream_id]");i=this.$filters.filter("[data-id=peepso_stream_id]");s=i.find('[data-option-value="'+t+'"]');a=i.find(".ps-js-dropdown-toggle");if(e.val()===t||!s.length){return}e.val(t);a.find("span").text(s.find("span").text());a.find('[class*="ps-icon-"]').attr("class",s.find('[class*="ps-icon-"]').attr("class"))},this)(window.location.hash.slice(1));this.$filterNotice=h("#ps-stream__filters-warning");if(this.$filterNotice.length){this.$filterNotice.data("html",this.$filterNotice.html().trim())}this.filterNoticeMap={};this.$filters.filter("[data-id=peepso_stream_id]").find("[data-option-value]").each(h.proxy(function(t,e){var i=h(e),s=i.data("option-value"),a=i.data("option-label-warning");this.filterNoticeMap[s]=a},this));this.streamData={};h("[id^=peepso_stream_]").each(h.proxy(function(t,e){var i=e.id.replace(/^peepso_/,""),s=e.value;this.streamData[i]=s;if(i==="stream_id"){if(!l&&s==="core_scheduled"){this.allowHideMyPosts(false)}else{this.allowHideMyPosts(true)}}},this));h(document).on("peepso_login_shown",function(){this.$loading.hide()});this.$filters.on("click",".ps-js-dropdown-toggle",h.proxy(this.onFilterToggle,this));this.$filters.on("click","[data-option-value]",h.proxy(this.onFilterSelect,this));this.$filters.on("click",".ps-js-cancel",h.proxy(this.onFilterCancel,this));this.$filters.on("click",".ps-js-apply",h.proxy(this.onFilterApply,this));this.$filters.on("click","[type=text]",h.proxy(this.onFilterFocus,this));this.$filters.on("keyup","[type=text]",h.proxy(this.onFilterKeyup,this));this.$filters.on("click",".ps-js-search",h.proxy(this.onFilterSearch,this));this.loadEverything=window.location.hash==="#everything";if(this.loadEverything){if(!confirm("Are you sure want to load every post?")){this.loadEverything=false}}var s=h("#ps-activitystream-search");this.search(s.eq(0).val());peepso.observer.addAction("peepso_stream_reset",h.proxy(function(){this.search(s.eq(0).val())},this));peepso.observer.addFilter("post_saved_notice",h.proxy(function(t){if("core_saved"===this.streamData["stream_id"]){t=false}return t},this),10,1)},search:function(t){var e,i;t=h.trim(t||"");this.searchKeyword=t;this.searchMode="exact";this.reset();e=h(".ps-js-activitystream-filter").filter("[data-id=peepso_search]").find(".ps-js-dropdown-toggle").find("span");if(e.length){if(!t){i=e.data("empty")}else{i=e.data("keyword");i+=t+'<i class="ps-icon-remove"></i>';e.one("click","i",h.proxy(function(t){h("#ps-activitystream-search").val("");this.search("")},this))}e.html(i)}},autoload:function(e){if(e!==this._token){return}if(this.loading){return}if(!s&&this.hideFromGuest){this.$loading.hide();return false}if(this.shouldLoad()){this.loading=true;this.load(e).done(h.proxy(function(){this.loading=false;if(!this.isPermalink&&!this.loadEnd){this.autoload(e)}},this))}else if(this.loadButtonEnabled&&!this.$loadButton){this.$loadButton=h(this.loadButtonTemplate).insertAfter(this.$el);this.$loadButton.one("click",h.proxy(function(t){h(t.currentTarget).remove();this.autoload(e)},this))}else if(!this._onScrollEnabled){this._onScrollEnabled=true;h(window).on(i,e,h.proxy(this.onScroll,this))}},shouldLoad:function(){var t=this.$el.children(".ps-js-activity"),e,i,s,a;if(this.loadEnd){return false}if(!t.length){return true}if(this.loadEverything){return true}if(this.loadButtonEnabled&&this.loadButtonRepeat){if(t.length%this.loadButtonRepeat===0){if(this.$loadButton){delete this.$loadButton;return true}else{return false}}else{return true}}e=t.slice(0-this.loadLimit).eq(0);if(!e.length){return false}if(this.loadButtonEnabled&&!this.$loadButton){s=e.eq(0).offset()}else{s=e[0].getBoundingClientRect()}a=window.innerHeight||document.documentElement.clientHeight;if(s.top<a){return true}return false},load:function(a){var o=this,t=peepso.disableAuth().disableError(),e="activity.show_posts_per_page",r;r=_.extend({uid:s,user_id:d,post_id:p,context:c,page:this.loadPage,search:this.searchKeyword||undefined,search_mode:this.searchKeyword&&this.searchMode||undefined,pinned:this.loadPage===1?1:undefined},this.streamData||{});r=peepso.observer.applyFilters("show_more_posts",r);return h.Deferred(function(s){o.$loading.show();t.postJson(e,r,function(t){if(a!==o._token){return}o.$loading.hide();if(t.data.found_posts>0){var e=+t.data.act_id;if(!e){o.render(t.data.posts)}else if(o.loadIds.indexOf(e)===-1){o.loadIds.push(e);o.render(t.data.posts)}o.loadPage++}else{o.loadEnd=true}if(o.loadEnd){if(r.page>1){var i=peepso.observer.applyFilters("activitystream_pending_html","");if(i){o.render(i)}o.$noMorePosts.show()}else if(o.searchKeyword){o.$noPostsMatch.show()}else{o.$noPosts.show()}}s.resolve()})})},reset:function(){this.loading=false;this.loadEnd=false;this.loadPage=1;this.loadIds=[];this._onScrollEnabled=false;h(window).off(i);if(this.$loadButton){this.$loadButton.remove();this.$loadButton=undefined}this.$el.empty().hide();this.$recent.empty();this.$noMorePosts.hide();this.$noPosts.hide();this.$noPostsMatch.hide();var t=this.filterNoticeMap[this.streamData["stream_id"]];if(!t){this.$filterNotice.hide()}else{this.$filterNotice.html(this.$filterNotice.data("html").replace("%s",t));this.$filterNotice.show()}this._token=(new Date).getTime();this.autoload(this._token)},render:function(t){t=t.replace(/\/embed\/(#\?secret=[a-zA-Z0-9]+)?"/g,'/?embed=true$1"');var e=h(t),s=this.searchKeyword,a=this.searchMode,o;e=peepso.observer.applyFilters("peepso_activity",e);e.find(".ps-js-activity-content, .ps-comment-item, .ps-stream-quote").each(function(){var t=h(this),e=t.html();e=peepso.observer.applyFilters("peepso_activity_content",e);t.html(e)});if(s){o='<span class="ps-text--highlight">$1</span>';e.find(".ps-js-activity-content").each(function(){var t=h(this),e=t.html(),i=[s];if(a==="any"){i=_.filter(s.split(" "),function(t){return t})}i=_.map(i,function(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")});i=RegExp("("+i.join("|")+")(?![^<>]+>)","ig");e=e.replace(i,o);t.html(e)})}if(this.$el.is(":hidden")){this.$el.show()}try{e.appendTo(this.$el)}catch(t){}e.hide().fadeIn(1e3,function(){h(document).trigger("ps_activitystream_loaded");e.find(".ps-stream-body input[name=peepso_set_human_friendly]").each(function(){var t=h(this),e=t.siblings(".ps-js-activity-content"),i=e.closest(".ps-js-activity"),s=+peepsodata.is_admin,a=s||+i.data("author")===+peepsodata.currentuserid,o,r;if(a){o=e.get(0).innerText.trim();r=peepso.observer.applyFilters("human_friendly_extras",[],o,i[0]);if(r.length){if(o){r.unshift(o)}o=r.join(". ")}if(!o){e=i.find(".ps-stream-header .ps-stream-action-title");if(e.length){o=e.get(0).innerText.trim()}}o=o.replace(/\r?\n/g," ");n.post.setHumanReadable(t.val(),o)}});e.each(function(){peepso.observer.doAction("post_loaded",this);var t=peepsodata&&+peepsodata.currentuserid;if(t){var e=h(this).closest(".ps-js-activity");if(e.length){var i=e.data("id");n.post.trackView(i)}}});if(t.match(/\sdata-instgrm-permalink/)){setTimeout(function(){try{window.instgrm.Embeds.process()}catch(t){}},1e3)}})},allowHideMyPosts:function(t){var e=this.$filters.filter("[data-id=peepso_stream_filter_show_my_posts]"),i=e.find(".ps-js-dropdown-toggle"),s,a,o;if(t){i.removeAttr("disabled");return}i.attr("disabled","disabled");s=h("#"+e.data("id"));s.val(1);a=e.find("[data-option-value]");a.find("[type=radio][value=0]")[0].checked=false;a.find("[type=radio][value=1]")[0].checked=true;o=a.filter("[data-option-value=1]");i.find("span").text(o.find("span").text());i.find('[class*="ps-icon-"]').attr("class",o.find('[class*="ps-icon-"]').attr("class"))},onScroll:_.throttle(function(t){var e=t.data;this.autoload(e)},1),onFilterToggle:_.debounce(function(t){var e=h(t.currentTarget),i=e.closest(".ps-js-activitystream-filter"),s=i.data("id").replace(/^peepso_/,""),a=this.streamData[s],o;if(i.is(":visible")){o=i.find("[type=radio]").filter('[value="'+a+'"]');if(o.length){o[0].checked=true}}},1),onFilterSelect:function(t){var e=h(t.currentTarget),i=e.find("[type=radio]");t.preventDefault();t.stopPropagation();_.defer(function(){i[0].checked=true})},onFilterCancel:function(t){var e=h(t.currentTarget),i=e.closest(".ps-js-activitystream-filter"),s=i.find(".ps-js-dropdown-toggle");s.focus()},onFilterApply:function(t){var e=h(t.currentTarget),i=e.closest(".ps-js-activitystream-filter"),s=i.find(".ps-js-dropdown-toggle"),a=h("#"+i.data("id")),o=i.find("[type=radio]:checked").closest("[data-option-value]"),r=o.data("optionValue"),n=i.data("id").replace(/^peepso_/,"");a.val(r);this.streamData[n]=r;s.find("span").text(o.find("span").text());s.find('[class*="ps-icon-"]').attr("class",o.find('[class*="ps-icon-"]').attr("class"));s.focus();if(n==="stream_id"){if(!l&&r==="core_scheduled"){this.allowHideMyPosts(false)}else{this.allowHideMyPosts(true)}}this.reset()},onFilterFocus:function(t){t.stopPropagation()},onFilterKeyup:function(t){var e,i;t.stopPropagation();if(t.which===13){e=h(t.currentTarget).closest(".ps-js-activitystream-filter");i=e.find(".ps-js-search");i.click()}},onFilterSearch:function(t){var e=h(t.currentTarget),i=e.closest(".ps-js-activitystream-filter"),s=i.find(".ps-js-dropdown-toggle"),a=h("#"+i.data("id")),o=i.find("[type=radio]:checked").closest("[data-option-value]"),r=i.find("[type=text]"),n=o.data("optionValue"),l=i.data("id").replace(/^peepso_/,""),d=r.val().trim(),p=s.find("span").data(d?"keyword":"empty");a.val(n);this.searchKeyword=d;this.searchMode=n;if(!d){p=s.find("span").data("empty")}else{p=s.find("span").data("keyword");p=p+d+'<i class="ps-icon-remove"></i>'}s.find("span").html(p).off("click","i").one("click","i",h.proxy(function(t){var e=h(t.target).closest(".ps-js-dropdown-toggle"),i=e.closest(".ps-js-activitystream-filter"),s=i.find("[type=text]"),a=h("#"+i.data("id"));t.stopPropagation();s.val("");a.val("");e.find("span").html(e.find("span").data("empty"));this.searchKeyword="";this.searchMode="";this.reset()},this));s.focus();this.reset()}})}("PsActivityStream",jQuery,peepso.observer,peepso.modules);jQuery(function(t){var e,i=t("#ps-activitystream");i.length&&(e=peepsodata&&peepsodata.activity||{},new s(i[0],e))})}(window);