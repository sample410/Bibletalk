!function a(s,l,c){function r(e,t){if(!l[e]){if(!s[e]){var o="function"==typeof require&&require;if(!t&&o)return o(e,!0);if(p)return p(e,!0);var i=new Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}var n=l[e]={exports:{}};s[e][0].call(n.exports,function(t){return r(s[e][1][t]||t)},n,n.exports,a,s,l,c)}return l[e].exports}for(var p="function"==typeof require&&require,t=0;t<c.length;t++)r(c[t]);return r}({1:[function(t,e,s){(function(t){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var e,c=(e="undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null)&&e.__esModule?e:{default:e};function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var o=[],i=!0,n=!1,a=void 0;try{for(var s,l=t[Symbol.iterator]();!(i=(s=l.next()).done)&&(o.push(s.value),!e||o.length!==e);i=!0);}catch(t){n=!0,a=t}finally{try{i||null==l.return||l.return()}finally{if(n)throw a}}return o}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function i(t,e){for(var o=0;o<e.length;o++){var i=e[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var a=("undefined"!=typeof window?window.peepsodata:void 0!==t?t.peepsodata:null).location.api_key,o=null,n=function(){function t(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),o=o||this}return function(t,e,o){e&&i(t.prototype,e),o&&i(t,o)}(t,[{key:"search",value:function(e){var n=this;return new Promise(function(o,i){n.autocompleteService().then(function(t){t.getPlacePredictions({input:e},function(t,e){"OK"===e?(console.log(t),o(t.map(n.mapData))):i(e)})})})}},{key:"geocode",value:function(t){var n=this;return new Promise(function(o,i){n.loadAPI().then(function(){(new google.maps.Geocoder).geocode({address:t},function(t,e){"OK"===e?o(n.mapData(t[0])):i(e)})})})}},{key:"mapData",value:function(t){var e,o,i=t.place_id,n=t.geometry,a=r((t.formatted_address||t.description).split(/,\s(.+)?/),2),s=a[0],l=a[1],c=void 0===l?"":l;return n&&(e=n.location.toJSON(),o=n.viewport.toJSON()),{id:i,name:s,description:c,location:e,viewport:o}}},{key:"render",value:function(t,e){var o=(0,c.default)(t).show(),i=o.data("psMap"),n=o.data("psMapMarker"),a=e.name,s=e.location,l=e.viewport;i||o.data("psMap",i=new google.maps.Map(t,{center:s,disableDefaultUI:!0,draggable:!1,scrollwheel:!1,zoom:15})),n||o.data("psMapMarker",n=new google.maps.Marker({map:i,position:s,title:a})),i.setCenter(s),i.fitBounds(l),n.setPosition(s)}},{key:"loadAPI",value:function(){var n=this;return new Promise(function(t,e){var o,i;n.loaded?t():(n.queue=n.queue||[],n.queue.push({resolve:t,reject:e}),n.loading||(n.loading=!0,i=_.uniqueId("psCallback"),(o=document.createElement("script")).type="text/javascript",o.src="https://maps.googleapis.com/maps/api/js?libraries=places"+(a?"&key="+a:"")+"&callback="+i,window[i]=function(){for(n.loaded=!0,n.loading=!1;n.queue.length;)n.queue.shift().resolve();delete window[i]},document.body.appendChild(o)))})}},{key:"autocompleteService",value:function(){var o=this;return new Promise(function(e,t){o.loadAPI().then(function(){var t="_cacheAutocompleteService";o[t]=o[t]||new google.maps.places.AutocompleteService,e(o[t])})})}},{key:"placesService",value:function(){var i=this;return new Promise(function(o,t){i.loadAPI().then(function(){var t="_cachePlacesService",e=document.createElement("div");document.body.appendChild(e),i[t]=i[t]||new google.maps.places.PlacesService(e),o(i[t])})})}},{key:"placeDetail",value:function(a){var s=this;return new Promise(function(i,n){s.placesService().then(function(t){var o="_cachePlaceDetail";s[o]=s[o]||{},s[o][a]?i(s[o][a]):t.getDetails({placeId:a},function(t,e){"OK"===e?(t=s.mapData(t),s[o][a]=t,i(t)):n(e)})})})}}]),t}();s.default=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(i,t,e){(function(t){"use strict";var e,n=(e="undefined"!=typeof window?window.jQuery:void 0!==t?t.jQuery:null)&&e.__esModule?e:{default:e},o="undefined"!=typeof window?window.peepso:void 0!==t?t.peepso:null;i("./google-maps"),i("./location"),i("./postbox"),o.observer.addFilter("human_friendly_extras",function(t,e,o){if(!e&&o){var i=(0,n.default)(o).find(".ps-js-activity-extras [data-preview]");i.length&&t.push(i.data("preview"))}return t},20,3)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./google-maps":1,"./location":3,"./postbox":4}],3:[function(t,e,o){(function(t){"use strict";var e,o,r,h=(e="undefined"!=typeof window?window.peepsodata:void 0!==t?t.peepsodata:null)&&e.__esModule?e:{default:e};function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}o=window,r=jQuery,o.pslocation=new(function(n,u){function e(){this.coords=null;this.$places_container=null;this.$input_search=null;this.marker=null;this.map=null;this.selected_place=null;this._search_service=null;this._latLang=null;this.last_selected_place=null;this.location_selected=false;this.can_submit=false}return e.prototype.init=function(){if(!_.isNull(this.$postbox)){var i=this;peepso.observer.addFilter("peepso_postbox_can_submit",function(t){return t.soft.push(i.can_submit),t},30,1),u(this.$postbox).on("click","#location-tab a",function(){i.toggle_input()}),this.$input_search=u("[name=postbox_loc_search]",this.$postbox),this.$container=u("#pslocation",this.$postbox).on("click",function(t){t.stopPropagation()}),this.$postboxcontainer=this.$postbox.$textarea.parent(),this.$places_container=u(".ps-postbox-locations",this.$container);var o=null;this.$input_search.on("keyup",function(){var t=this;clearTimeout(o);var e=u("<li>"+u("#pslocation-search-loading").html()+"</li>");i.$places_container.html(e),o=setTimeout(function(){i.location_search(u(t).val())},1500)}),peepso.observer.addFilter("postbox_req_"+this.$postbox.guid,function(t,e){return i.postbox_request(t,e)},10,1),this.$postbox.on("postbox.post_cancel postbox.post_saved",function(t,e,o){i.postbox_cancel_saved(e,o)}),this.$select_location=u(".ps-location-action .ps-add-location",this.$container),this.$remove_location=u(".ps-location-action .ps-remove-location",this.$container),this.$select_location.on("click",function(t){t.preventDefault(),i.on_select_location()}),this.$remove_location.on("click",function(t){t.preventDefault(),i.on_remove_location()}),u(this.$postbox).on("peepso.interaction-hide","#location-tab a",function(){i.$container.addClass("hidden")}),peepso.observer.addFilter("peepso_postbox_addons_update",function(t){return i.location_selected&&t.unshift("<b><i class=ps-icon-map-marker></i>"+i.location_selected+"</b>"),t},10,1)}},e.prototype.postbox_request=function(t,e){return null!==this.selected_place&&(t.location={name:this.selected_place.name,latitude:this.selected_place.geometry.location.lat(),longitude:this.selected_place.geometry.location.lng()}),t},e.prototype.postbox_cancel_saved=function(t,e){this.$container.addClass("hidden"),this.$input_search.val(""),this.$remove_location.hide(),this.$select_location.show(),this.$postboxcontainer.find("span#postlocation").remove(),this.selected_place=null,this.location_selected=!1,this.can_submit=!1,this.$postbox.on_change()},e.prototype.set_postbox=function(t){this.$postbox=t},e.prototype.location_search=function(t,o){var i=this;_.isEmpty(this.map)&&(this._latLang=new google.maps.LatLng(0,0),this.draw_map(this._latLang)),_.isEmpty(t)?this.draw_map(this._latLang):this.get_search_service().textSearch({query:t,location:this._latLang,radius:5e4},function(t,e){i.set_places(t,e),i.$select_location.is(":visible")||i.$places_container.find("li").first().trigger("click"),("undefined"==typeof Function?"undefined":a(Function))===a(o)&&o()})},e.prototype.on_select_location=function(){null===this.selected_place&&(this.selected_place=this.last_selected_place),this.$select_location.hide(),this.$remove_location.show(),this.$container.addClass("hidden"),this.$container.closest(".ps-postbox__menu-item").addClass("active"),this.location_selected="",this.selected_place&&(this.location_selected=this.selected_place.name),this.can_submit=!0,this.$postbox.on_change()},e.prototype.on_remove_location=function(){this.$select_location.show(),this.$remove_location.hide(),this.selected_place=null,this.$postboxcontainer.find("span#postlocation").remove(),this.$container.addClass("hidden"),this.$container.closest(".ps-postbox__menu-item").removeClass("active"),this.location_selected=!1,this.can_submit=!1,this.$postbox.on_change()},e.prototype.toggle_input=function(){if(this.$container.hasClass("hidden")?(this.$container.removeClass("hidden"),jQuery(document).off("click.ps-postbox-location"),setTimeout(jQuery.proxy(function(){var t="click.ps-postbox-location";jQuery(document).off(t).one(t,jQuery.proxy(function(){this.$container.addClass("hidden"),jQuery(document).off("click.ps-postbox-location")},this))},this),1)):(this.$container.addClass("hidden"),jQuery(document).off("click.ps-postbox-location")),this.$input_search.val(""),this.location=null,!this.$container.hasClass("hidden")){var t=this;this.load_library(function(){t.shown()}.bind(t))}},e.prototype.shown=function(){var o=this;this.$input_search.focus(),!1!==_.isEmpty(this.map)&&this.detect_location().done(function(t,e){o.draw_default_map(t,e)}).fail(function(){o.draw_default_map()})},e.prototype.draw_default_map=function(t,e){if(t&&e){var o=new google.maps.LatLng(t,e);this.draw_map(o)}else{this.$postbox.find(".ps-postbox-map").show(),this.$input_search.removeAttr("disabled"),this.$input_search.focus()}},e.prototype.draw_map=function(t,e){if(!1===_.isBoolean(e)&&(e=!0),!1!=t instanceof google.maps.LatLng){var o=this.$postbox.find(".ps-postbox-map");u("#pslocation .ps-postbox-loading",this.$postbox).hide(),o.show(),this.$input_search.removeAttr("disabled");var i=this,n={center:this._latLang=t,zoom:15,draggable:!1,scrollwheel:!1,disableDefaultUI:!0};if(peepso.observer.applyFilters("ps_location_before_draw_map",u("#pslocation",this.$postbox)),_.isEmpty(this.map)?(this.map=new google.maps.Map(o.get(0),n),this.marker=new google.maps.Marker({position:n.center,map:this.map,title:"You are here (more or less)"})):this.set_map_center(this._latLang),e){var a={location:this._latLang,types:["establishment"],rankBy:google.maps.places.RankBy.DISTANCE};this.get_search_service().nearbySearch(a,function(t,e){i.set_places(t,e),i.$select_location.is(":visible")||i.$places_container.find("li").first().trigger("click")})}}},e.prototype.get_search_service=function(){return _.isEmpty(this.search_service)&&(this._search_service=new google.maps.places.PlacesService(this.map)),this._search_service},e.prototype.set_places=function(t,e){var o=this;if(this.$places_container.find("li").remove(),e===google.maps.places.PlacesServiceStatus.OK)for(var i=0;i<t.length;i++)this.add_place(t[i]);u("li",this.$places_container).on("click",function(){u(".ps-location-action",this.$container).show(),o.$select_location.show(),o.$remove_location.hide()})},e.prototype.add_place=function(t){if(_.isEmpty(t.formatted_address)||(t.vicinity=t.formatted_address),!_.isEmpty(t.vicinity)){var e=this,o=u("<li></li>");o.append("<p class='reset-gap'>"+t.name+"</p>"),o.append("<span>"+t.vicinity+"</span>"),this.$places_container.append(o),o.on("click",function(){e.set_map_center(t.geometry.location),e.$input_search.val(t.name),e.selected_place=t,e.last_selected_place=e.selected_place})}},e.prototype.set_map_center=function(t){this.map.setCenter(t),this.marker.setPosition(t)},e.prototype.load_library=function(t){if(this.gmap_is_loaded)t();else if(this.load_library_callbacks||(this.load_library_callbacks=[]),this.load_library_callbacks.push(t),!this.gmap_is_loading){this.gmap_is_loading=!0;var e=document.createElement("script"),o=h.default.location.api_key,i=this;e.type="text/javascript",e.src="https://maps.googleapis.com/maps/api/js?libraries=places"+(o?"&key="+o:"")+"&callback=ps_gmap_callback",n.ps_gmap_callback=function(){for(i.gmap_is_loaded=!0,i.gmap_is_loading=!1;i.load_library_callbacks.length;)i.load_library_callbacks.shift()();delete n.ps_gmap_callback},document.body.appendChild(e)}},e.prototype.show_map=function(n,a,t){peepso.lightbox([{content:'<div class="ps-js-mapct" style="width:700px;height:400px;display:inline-block" />'}],{simple:!0,nofulllink:!0,afterchange:u.proxy(function(i){this.load_library(function(){var t=i.$container.find(".ps-js-mapct"),e=new google.maps.LatLng(n,a),o=new google.maps.Map(t[0],{center:e,zoom:14});new google.maps.Marker({position:e,map:o})})},this)})},e.prototype.init_location_search=function(i){if(!i.data("location-search")){i.data("location-search",1);var t=h.default.location.template_selector,a=u(t),n=(a.children(".ps-js-location"),a.find(".ps-js-location-map")),s=a.find(".ps-js-location-list"),e=a.find(".ps-js-close"),l=a.find(".ps-js-select"),c=a.find(".ps-js-remove"),r=a.find(".ps-js-location-loading"),p=a.find(".ps-js-location-result"),o=a.find(".ps-js-location-placeholder"),d=a.find(".ps-js-location-listitem").get(0).outerHTML;i.on("input.ps-location",u.proxy(_.debounce(function(t){var e=t.target.value;e&&(o&&(o.remove(),o=null),p.hide(),r.show(),a.show(),this.search(e).done(function(t){var e,o,i,n=[];for(i=0;i<t.length;i++)e=(e=t[i].description).split(/,\s(.+)?/),o=d.replace("{place_id}",t[i].place_id).replace("{name}",e[0]).replace("{description}",e[1]||"&nbsp;"),n.push(o);s.html(n.join("")),r.hide(),p.show(),a.show()}))},200),this)),i.on("blur.ps-location",u.proxy(function(t){a.hide(),l.hide(),i.val(i.data("location")||""),i.data("location")&&c.show()},this)),i.on("focus.ps-location",u.proxy(function(t){s.find(".ps-location-selected").removeClass("ps-location-selected"),a.show()},this)),s.on("mousedown","a.ps-js-location-listitem",u.proxy(function(t){var e=u(t.currentTarget),o=(e.find(".ps-js-location-listitem-name").text(),e.data("place-id"));t.preventDefault(),t.stopPropagation(),e.addClass("ps-location-selected"),e.siblings().removeClass("ps-location-selected"),l.show(),c.hide(),n.show(),this._gmap_get_place_detail(o).done(u.proxy(function(t){var e=t.name,o=t.geometry.location;i.data("tmp-location",e).data("tmp-latitude",o.lat()).data("tmp-longitude",o.lng()),this._gmap_render_map(n[0],t)},this))},this)),e.on("mousedown",function(){i.trigger("blur.ps-location")}),l.on("mousedown",function(t){t.preventDefault(),t.stopPropagation(),i.data("location",i.data("tmp-location")),i.data("latitude",i.data("tmp-latitude")),i.data("longitude",i.data("tmp-longitude")),i.val(i.data("location")),l.hide(),c.show(),i.trigger("blur.ps-location")}),c.on("mousedown",function(t){t.preventDefault(),t.stopPropagation(),i.removeData("location").removeData("latitude").removeData("longitude").val(""),s.find(".ps-location-selected").removeClass("ps-location-selected"),c.hide(),n.hide()}),a.insertAfter(i)}},e.prototype.search=function(e){return u.Deferred(u.proxy(function(o){this._gmap_get_autocomplete_service().done(function(t){t.getPlacePredictions({input:e},function(t,e){"OK"===e&&o.resolve(t)})})},this))},e.prototype.detect_location=function(){var t=this;return u.Deferred(function(o){"https:"!==n.location.protocol?o.reject():t.detect_location_by_device().done(function(t,e){o.resolve(t,e)}).fail(function(){t.detect_location_by_gmap_api().done(function(t,e){o.resolve(t,e)}).fail(function(){t.detect_location_by_ip().done(function(t,e){o.resolve(t,e)}).fail(function(){o.reject()})})})})},e.prototype.detect_location_by_device=function(){return u.Deferred(u.proxy(function(e){navigator.geolocation.getCurrentPosition(function(t){e.resolve(t.coords.latitude,t.coords.longitude)},function(){e.reject()},{timeout:1e4})},this))},e.prototype.detect_location_by_gmap_api=function(){return u.Deferred(u.proxy(function(e){var t=h.default.location.api_key;this._client_location?e.resolve(this._client_location):t?u.post("https://www.googleapis.com/geolocation/v1/geolocate?key="+t,function(t){e.resolve(t.location.lat,t.location.lng)}).fail(function(t){e.reject(t)}):e.reject()},this))},e.prototype.detect_location_by_ip=function(){return u.Deferred(u.proxy(function(i){var n;u.ajax({url:"https://ipapi.co/jsonp",dataType:"jsonp",success:function(t){var e=t.latitude,o=t.longitude;e&&o&&(n=!0,i.resolve(e,o))},complete:function(){n||i.reject()}})},this))},e.prototype._gmap_load_library=function(){return u.Deferred(u.proxy(function(t){this.load_library(function(){t.resolve()})},this))},e.prototype._gmap_get_autocomplete_service=function(){return u.Deferred(u.proxy(function(t){this._gmap_autocomplete_service?t.resolve(this._gmap_autocomplete_service):this._gmap_load_library().done(u.proxy(function(){this._gmap_autocomplete_service=new google.maps.places.AutocompleteService,t.resolve(this._gmap_autocomplete_service)},this))},this))},e.prototype._gmap_render_map=function(t,e){var o,i,n,a;e.geometry?(o=e.geometry.location,i=e.geometry.viewport):o=new google.maps.LatLng(e.latitude,e.longitude),n=(t=u(t).show()).data("ps-map"),a=t.data("ps-map-marker"),n||(n=new google.maps.Map(t[0],{center:o,zoom:15,draggable:!1,scrollwheel:!1,disableDefaultUI:!0}),t.data("ps-map",n)),a||(a=new google.maps.Marker({position:o,map:n,title:"You are here (more or less)"}),t.data("ps-map-marker",a)),n.setCenter(o),a.setPosition(o),i?n.fitBounds(i):n.setZoom(15)},e.prototype._gmap_get_place_service=function(){return u.Deferred(u.proxy(function(e){this._gmap_place_service?e.resolve(this._gmap_place_service):this._gmap_load_library().done(u.proxy(function(){var t=document.createElement("div");document.body.appendChild(t),this._gmap_place_service=new google.maps.places.PlacesService(t),e.resolve(this._gmap_place_service)},this))},this))},e.prototype._gmap_get_place_detail=function(i){return u.Deferred(u.proxy(function(o){this._gmap_place_cache&&this._gmap_place_cache[i]?o.resolve(this._gmap_place_cache[i]):this._gmap_get_place_service().done(u.proxy(function(t){t.getDetails({placeId:i},u.proxy(function(t,e){"OK"===e?(this._gmap_place_cache||(this._gmap_place_cache={}),this._gmap_place_cache[i]=t,o.resolve(t)):o.reject(e)},this))},this))},this))},peepso.observer.addFilter("peepso_postbox_addons",function(t){return t.push(new e),t},10,1),e}(o,r)),peepso.observer.addFilter("photo_create_album",function(t){var e=t.popup.find(".ps-js-location");return pslocation.init_location_search(e),t},10,1),r(function(){peepso.observer.addFilter("profile_field_save",function(t,e){if(e.hasClass("ps-js-field-location")){var o=e.data();if(o.location&&o.latitude&&o.longitude)return JSON.stringify({name:o.location,latitude:o.latitude,longitude:o.longitude})}return t},10,2),peepso.observer.addAction("profile_field_save_register",function(t){if(t.hasClass("ps-js-field-location")){var e,o=t.data();o.location&&o.latitude&&o.longitude&&(e=r('<input type="hidden" name="'+t.attr("name")+'" />'),t.removeAttr("name"),e.insertAfter(t),e.val(JSON.stringify({name:o.location,latitude:o.latitude,longitude:o.longitude})))}},10,1),r(".ps-js-field-location").each(function(){pslocation.init_location_search(r(this))})}),r(function(){var t,e=r(".ps-js-album-location"),i=e.find(".ps-js-album-location-text"),n=e.find(".ps-js-album-location-empty"),a=e.find(".ps-js-album-location-editor"),s=e.find(".ps-js-album-location-edit"),l=e.find(".ps-js-album-location-remove"),c=(a.find(".ps-js-submit"),a.find("input").eq(0));s.click(function(){a.is(":visible")||(i.hide(),n.hide(),s.hide(),l.hide(),a.show(),c.data("original-value",t=c.val()),c.focus().val("").val(t),pslocation.init_location_search(c),a.off("click input"),a.on("click",".ps-js-cancel",function(){c.val(t),a.off("click").hide(),s.show(),t?(i.show(),l.show()):n.show()}),a.on("click",".ps-js-submit",r.proxy(function(t){var e=c.data(),o={user_id:h.default.userid,post_id:e.postId,type_extra_field:"location","location[name]":e.location,"location[latitude]":e.latitude,"location[longitude]":e.longitude,_wpnonce:r("#_wpnonce_set_album_location").val()};peepso.postJson("photosajax.set_album_extra_field",o,function(t){t.success&&(a.off("click").hide(),c.val(e.location),i.find("span").html(e.location),i.show(),n.hide(),s.show(),l.show())})},this)))}),l.click(function(){var t=l.data(),e={user_id:h.default.userid,post_id:t.postId,type_extra_field:"location",location:"",_wpnonce:r("#_wpnonce_set_album_location").val()};peepso.postJson("photosajax.set_album_extra_field",e,function(t){t.success&&(c.val(""),i.find("span").html(""),i.hide(),n.show(),l.hide())})})})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(t,e,o){"use strict";var i;i=function(i){var o=".ps-postbox-location";function t(){this.__constructor.apply(this,arguments)}return t.prototype={__constructor:function(t){var e=peepsodata.location&&peepsodata.location.template_postbox||"";this.postbox=t,this.$doc=i(document),this.$toggle=t.$tabContext.find("#location-tab"),this.$dropdown=t.$tabContext.find("#pslocation").html(e),this.$input=this.$dropdown.find("input[type=text]"),this.$loading=this.$dropdown.find(".ps-js-location-loading"),this.$result=this.$dropdown.find(".ps-js-location-result"),this.$list=this.$dropdown.find(".ps-js-location-list"),this.$map=this.$dropdown.find(".ps-js-location-map"),this.$select=this.$dropdown.find(".ps-js-select"),this.$remove=this.$dropdown.find(".ps-js-remove"),this.listItemTemplate=peepso.template(this.$dropdown.find(".ps-js-location-fragment").text()),this.$toggle.on("click"+o,i.proxy(this.onToggle,this)),this.$input.on("input"+o,i.proxy(this.onInput,this)),this.$list.on("mousedown"+o,"a.ps-js-location-listitem",i.proxy(this.onSelectItem,this)),this.$select.on("mousedown"+o,i.proxy(this.onSelect,this)),this.$remove.on("mousedown"+o,i.proxy(this.onRemove,this)),t.addAction("update",this.update,10,2,this),t.addFilter("render_addons",this.render,10,1,this),t.addFilter("data",this.filterData,10,1,this),t.addFilter("data_validate",this.validate,10,2,this)},show:function(){this.$dropdown.removeClass("hidden"),this.$doc.on("click"+o,i.proxy(this.onDocumentClick,this)),this._needUpdate&&(this._needUpdate=!1,this._selected?(this.$map.show(),this.$select.hide(),this.$remove.show(),this.$result.show(),this.updateList([{place_id:"",name:this._selected.name,description:this._selected.description}]),this.updateMap({latitude:this._selected.latitude,longitude:this._selected.longitude,zoom:this._selected.zoom})):(this.$map.hide(),this.$select.hide(),this.$remove.hide(),this.$result.hide(),this.updateList([])))},hide:function(){this.$dropdown.addClass("hidden"),this.$doc.off("click"+o)},toggle:function(){this.$dropdown.hasClass("hidden")?this.show():this.hide()},search:function(t){this.$result.hide(),this.$loading.show(),pslocation.search(t).done(i.proxy(function(t){for(var e,o=[],i=0;i<t.length;i++)e=(e=t[i].description).split(/,\s(.+)?/),o.push({place_id:t[i].place_id,name:e[0],description:e[1]});this.updateList(o),this.$loading.hide(),this.$result.show()},this))},filterData:function(t){return this._selected?t.location=this._selected:t.location="",t},validate:function(t){return!!this._selected||t},render:function(t){var e;return this._selected&&(e='<i class="ps-icon-map-marker"></i>',e+="<b>"+this._selected.name+"</b>",t.push(e)),t},update:function(t){(t=t&&t.data||{}).location?(this._selected={name:t.location.name,description:t.location.description,latitude:t.location.latitude,longitude:t.location.longitude,zoom:t.location.zoom},this.$input.data("location",t.location.name),this.$input.data("latitude",t.location.latitude),this.$input.data("longitude",t.location.longitude),this.$input.val(t.location.name)):this._selected=!1,this._needUpdate=!0,this.postbox.doAction("refresh")},updateList:function(t){for(var e=[],o=0;o<t.length;o++)e.push(this.listItemTemplate(t[o]));this.$list.html(e.join(""))},updateMap:function(t){pslocation._gmap_load_library().done(i.proxy(function(){this.$map.show(),pslocation._gmap_render_map(this.$map[0],t)},this))},select:function(){},remove:function(){},destroy:function(){this.$toggle.off("click")},onToggle:_.throttle(function(t){t.preventDefault(),t.stopPropagation();var e=i(t.target);this.$dropdown.is(e)||this.$dropdown.find(e).length||this.toggle()},200),onInput:function(){var t=i.trim(this.$input.val());t&&(this.$result.hide(),this.$loading.show(),this._onInput(t))},_onInput:_.debounce(function(t){this.search(t)},200),onSelectItem:function(t){var e=i(t.currentTarget),o=(e.find(".ps-js-location-listitem-name").text(),e.data("place-id"));t.preventDefault(),t.stopPropagation(),e.addClass("ps-location-selected"),e.siblings().removeClass("ps-location-selected"),this.$select.show(),this.$remove.hide(),this.$map.show(),pslocation._gmap_get_place_detail(o).done(i.proxy(function(t){var e=t.name,o=t.geometry.location;this.$input.data("tmp-location",e).data("tmp-latitude",o.lat()).data("tmp-longitude",o.lng()),pslocation._gmap_render_map(this.$map[0],t)},this))},onSelect:function(t){t.preventDefault(),t.stopPropagation();var e=this.$input.data("tmp-location"),o=this.$input.data("tmp-latitude"),i=this.$input.data("tmp-longitude");this.$input.data("location",e),this.$input.data("latitude",o),this.$input.data("longitude",i),this.$input.val(e),this.$select.hide(),this.$remove.show(),this.$dropdown.addClass("hidden"),this._selected={name:e,latitude:o,longitude:i},this.postbox.doAction("refresh")},onRemove:function(t){t.preventDefault(),t.stopPropagation(),this.$input.removeData("location").removeData("latitude").removeData("longitude").val(""),this.$list.find(".ps-location-selected").removeClass("ps-location-selected"),this.$remove.hide(),this.$map.hide(),this._selected=!1,this.postbox.doAction("refresh")},onDocumentClick:function(t){i(t.target).closest(this.$toggle).length||this.hide()}},t}(jQuery),peepso.observer.addAction("postbox_init",function(t){new i(t)},10,1)},{}]},{},[2]);